<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Distribuidora L√°cteos</title>
    
    <!-- --- CONEXI√ìN PWA --- -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0066cc">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <style>
        /* ESTILOS VISUALES */
        :root {
            --primary: #0066cc;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --bg: #f4f4f9;
            --card-bg: #ffffff;
            --text: #333333;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); 
            margin: 0; 
            padding-bottom: 120px;
            color: var(--text);
        }

        header { 
            background-color: var(--primary); 
            color: white; 
            padding: 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Barra de estado Offline */
        #offline-status {
            background-color: var(--warning);
            color: #333;
            text-align: center;
            padding: 5px;
            font-size: 0.85rem;
            font-weight: bold;
            display: none;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 { margin: 0; font-size: 1.1rem; font-weight: normal; }

        #btn-install {
            background-color: white;
            color: var(--primary);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none; 
        }

        /* Bot√≥n de Sincronizaci√≥n (Pendientes) */
        #sync-banner {
            background-color: var(--danger);
            color: white;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            display: none;
            font-weight: bold;
            margin-bottom: 10px;
            border-radius: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .client-selector { 
            width: 100%; 
            padding: 10px; 
            border-radius: 6px; 
            border: none; 
            font-size: 1rem;
            background: white;
        }

        #app-container { 
            padding: 15px; 
            max-width: 600px; 
            margin: 0 auto; 
        }

        .product-card {
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 12px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .product-card.selected {
            border: 2px solid var(--primary);
            background-color: #f0f7ff;
        }

        .info { flex: 1; }
        .info h3 { margin: 0 0 5px 0; font-size: 1rem; }
        .info p { margin: 0; color: #666; font-size: 0.85rem; }
        .price { font-weight: bold; color: var(--primary); font-size: 1.1rem; }

        .controls { display: flex; align-items: center; gap: 10px; }
        
        .btn-qty {
            width: 32px; height: 32px; 
            border-radius: 50%; border: none;
            font-size: 1.2rem; font-weight: bold; color: white; 
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-minus { background-color: #e0e0e0; color: #555; }
        .btn-plus { background-color: var(--primary); }
        .selected .btn-minus { background-color: #ff4d4d; color: white; }

        .qty-display { font-weight: bold; font-size: 1.1rem; min-width: 25px; text-align: center; }

        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; 
            padding: 15px 20px; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 200;
        }
        
        .total-display { font-size: 1.2rem; font-weight: bold; }
        
        .btn-send {
            background-color: var(--success); 
            color: white; border: none;
            padding: 12px 25px; 
            border-radius: 30px; 
            font-weight: bold; font-size: 1rem;
        }
        .btn-send:disabled { background-color: #cccccc; opacity: 0.7; }

        .loading, .error { text-align: center; padding: 20px; color: #666; margin-top: 20px; }
        .error { color: #dc3545; }
    </style>
</head>
<body>

    <!-- Aviso Offline -->
    <div id="offline-status">‚ö†Ô∏è MODO SIN CONEXI√ìN</div>

    <header>
        <div class="header-top">
            <h1>Distribuidora L√°cteos</h1>
            <button id="btn-install">üì≤ Instalar</button>
        </div>
        
        <!-- Bot√≥n para subir pedidos pendientes -->
        <div id="sync-banner" onclick="sincronizarPendientes()">
            üì° Tienes <span id="sync-count">0</span> pedidos pendientes. ¬°Toca para enviar!
        </div>

        <select id="client-select" class="client-selector">
            <option value="">Cargando clientes...</option>
        </select>
    </header>

    <div id="app-container">
        <div class="loading">Conectando con la base de datos...</div>
    </div>

    <div class="bottom-bar">
        <div class="total-display">Total: $<span id="total-amount">0</span></div>
        <button id="btn-submit" class="btn-send" onclick="enviarPedido()" disabled>Confirmar</button>
    </div>

    <script>
        // --- ‚ö†Ô∏è PEGA TU URL DE APPS SCRIPT AQU√ç ---
        const API_URL = "https://script.google.com/macros/s/AKfycbyD1aKqu_YRB7E3T5nxXiLnd0zx7lQ9lV0AUbpbjWmWgLMdVqiDwz4HXPYi-o9Lci0QSg/exec"; 

        let productos = [];
        let carrito = {}; 

        const container = document.getElementById('app-container');
        const clientSelect = document.getElementById('client-select');
        const totalSpan = document.getElementById('total-amount');
        const btnSubmit = document.getElementById('btn-submit');
        const offlineStatus = document.getElementById('offline-status');
        const syncBanner = document.getElementById('sync-banner');
        const syncCount = document.getElementById('sync-count');

        // --- 1. INICIO INTELIGENTE (RED O CACH√â) ---
        async function iniciarApp() {
            verificarConexion(); // Chequear estado visual
            verificarPendientes(); // Chequear si hay pedidos viejos

            try {
                // Intentamos conectar a internet primero (Network First)
                const [resProd, resCli] = await Promise.all([
                    fetch(API_URL + "?action=getProductos"),
                    fetch(API_URL + "?action=getClientes")
                ]);

                productos = await resProd.json();
                const clientes = await resCli.json();

                // ¬°√âxito! Guardamos en memoria por si se corta la luz
                localStorage.setItem('db_productos', JSON.stringify(productos));
                localStorage.setItem('db_clientes', JSON.stringify(clientes));
                
                renderizarClientes(clientes);
                renderizarProductos(productos);

            } catch (error) {
                console.log("Modo Offline activado: Usando datos locales");
                
                // Si falla internet, buscamos en la memoria del celu
                const cachedProd = localStorage.getItem('db_productos');
                const cachedCli = localStorage.getItem('db_clientes');

                if (cachedProd && cachedCli) {
                    productos = JSON.parse(cachedProd);
                    const clientes = JSON.parse(cachedCli);
                    
                    renderizarClientes(clientes);
                    renderizarProductos(productos);
                    mostrarOffline(true); // Aviso visual
                } else {
                    container.innerHTML = `<div class="error"><p>‚ö†Ô∏è No hay conexi√≥n y no hay datos guardados.</p><p>Con√©ctate una vez para descargar el cat√°logo.</p></div>`;
                }
            }
        }

        // --- 2. L√ìGICA DE ENV√çO CON RESPALDO OFFLINE ---
        async function enviarPedido() {
            btnSubmit.disabled = true;
            btnSubmit.textContent = "Procesando...";

            // Preparar datos
            const itemsArray = [];
            let totalVenta = 0;
            productos.forEach(p => {
                const cant = carrito[p.ID_Producto] || 0;
                if (cant > 0) {
                    const subtotal = cant * p.Precio_Unitario;
                    totalVenta += subtotal;
                    itemsArray.push({
                        id: p.ID_Producto,
                        nombre: p.Nombre,
                        cantidad: cant,
                        subtotal: subtotal
                    });
                }
            });

            const clienteOption = clientSelect.options[clientSelect.selectedIndex];
            const pedidoFinal = {
                cliente: {
                    id: clientSelect.value,
                    nombre: clienteOption.text
                },
                total: totalVenta,
                items: itemsArray,
                fechaLocal: new Date().toLocaleString() // Guardamos fecha por si se env√≠a ma√±ana
            };

            // Intentar Enviar
            if (navigator.onLine) {
                try {
                    await fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(pedidoFinal)
                    });
                    
                    manejarExito(pedidoFinal, clienteOption.dataset.tel);

                } catch (error) {
                    // Si falla el fetch aunque el navegador diga que es online
                    guardarPedidoOffline(pedidoFinal);
                }
            } else {
                // Si el navegador sabe que est√° offline
                guardarPedidoOffline(pedidoFinal);
            }
        }

        function manejarExito(pedido, telefono) {
            alert("‚úÖ Pedido enviado correctamente");
            
            // L√≥gica WhatsApp (Opcional)
            const listaItems = pedido.items.map(i => `- ${i.cantidad}x ${i.nombre}`).join('\n');
            const mensaje = `Hola! Te confirmo pedido:\n${listaItems}\nTotal: $${pedido.total}`;
            const telLimpio = telefono ? telefono.replace(/[^0-9]/g, '') : "";
            
            if(confirm("¬øAbrir WhatsApp?")) {
                const url = telLimpio ? `https://wa.me/${telLimpio}?text=${encodeURIComponent(mensaje)}` : `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
                window.open(url, '_blank');
            }
            
            location.reload();
        }

        // --- 3. SISTEMA DE COLA OFFLINE ---
        function guardarPedidoOffline(pedido) {
            // Recuperamos la cola actual
            const pendientes = JSON.parse(localStorage.getItem('cola_pedidos') || "[]");
            pendientes.push(pedido);
            localStorage.setItem('cola_pedidos', JSON.stringify(pendientes));

            alert("üì∂ SIN CONEXI√ìN: El pedido se guard√≥ en el celular.\nToca el bot√≥n rojo arriba cuando recuperes se√±al.");
            location.reload();
        }

        function verificarPendientes() {
            const pendientes = JSON.parse(localStorage.getItem('cola_pedidos') || "[]");
            if (pendientes.length > 0) {
                syncBanner.style.display = 'block';
                syncCount.textContent = pendientes.length;
            } else {
                syncBanner.style.display = 'none';
            }
        }

        async function sincronizarPendientes() {
            const pendientes = JSON.parse(localStorage.getItem('cola_pedidos') || "[]");
            
            if (pendientes.length === 0) return;
            if (!navigator.onLine) {
                alert("‚ö†Ô∏è A√∫n no tienes conexi√≥n a internet.");
                return;
            }

            if(!confirm(`¬øEnviar los ${pendientes.length} pedidos pendientes ahora?`)) return;

            syncBanner.textContent = "üì° Enviando pedidos... por favor espera...";
            
            // Enviamos uno por uno
            let enviados = 0;
            const errores = [];

            for (const pedido of pendientes) {
                try {
                    await fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(pedido)
                    });
                    enviados++;
                } catch (e) {
                    errores.push(pedido); // Si falla, lo guardamos para intentar luego
                }
            }

            // Actualizamos la cola con los que fallaron (si hubo)
            localStorage.setItem('cola_pedidos', JSON.stringify(errores));

            if (errores.length === 0) {
                alert("‚úÖ ¬°Todos los pedidos pendientes se enviaron con √©xito!");
                location.reload();
            } else {
                alert(`‚ö†Ô∏è Se enviaron ${enviados}, pero ${errores.length} fallaron. Intenta de nuevo.`);
                verificarPendientes();
            }
        }

        // --- UTILIDADES ---
        function renderizarClientes(lista) {
            clientSelect.innerHTML = '<option value="">-- Selecciona un Cliente --</option>';
            lista.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.ID_Cliente; 
                opt.textContent = `${c.Nombre_Negocio} (${c.Due√±o})`;
                opt.dataset.tel = c.Telefono || ""; 
                clientSelect.appendChild(opt);
            });
        }

        function renderizarProductos(lista) {
            container.innerHTML = "";
            lista.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.id = `card-${p.ID_Producto}`;
                card.innerHTML = `
                    <div class="info">
                        <h3>${p.Nombre}</h3>
                        <p>${p.Categoria} | Stock: ${p.Stock_Actual} ${p.Unidad}</p>
                        <div class="price">$${p.Precio_Unitario}</div>
                    </div>
                    <div class="controls">
                        <button class="btn-qty btn-minus" onclick="cambiarCant('${p.ID_Producto}', -1)">-</button>
                        <span class="qty-display" id="qty-${p.ID_Producto}">0</span>
                        <button class="btn-qty btn-plus" onclick="cambiarCant('${p.ID_Producto}', 1)">+</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function cambiarCant(id, delta) {
            if (!carrito[id]) carrito[id] = 0;
            carrito[id] += delta;
            if (carrito[id] < 0) carrito[id] = 0;

            document.getElementById(`qty-${id}`).textContent = carrito[id];
            const card = document.getElementById(`card-${id}`);
            if (carrito[id] > 0) card.classList.add('selected');
            else card.classList.remove('selected');

            calcularTotal();
        }

        function calcularTotal() {
            let total = 0;
            let itemsCount = 0;
            productos.forEach(p => {
                const cant = carrito[p.ID_Producto] || 0;
                if (cant > 0) {
                    total += cant * p.Precio_Unitario;
                    itemsCount++;
                }
            });
            totalSpan.textContent = total.toLocaleString();
            
            const clienteSeleccionado = clientSelect.value;
            if (itemsCount > 0 && clienteSeleccionado !== "") {
                btnSubmit.disabled = false;
                btnSubmit.textContent = `Confirmar ($${totalSpan.textContent})`;
            } else {
                btnSubmit.disabled = true;
                btnSubmit.textContent = "Confirmar";
            }
        }

        clientSelect.addEventListener('change', () => calcularTotal());

        // Detectar cambios de conexi√≥n en vivo
        window.addEventListener('online', () => {
            mostrarOffline(false);
            verificarPendientes(); // Intenta sincronizar apenas vuelve internet
        });
        window.addEventListener('offline', () => mostrarOffline(true));

        function mostrarOffline(isOffline) {
            offlineStatus.style.display = isOffline ? 'block' : 'none';
        }
        function verificarConexion() {
            mostrarOffline(!navigator.onLine);
        }

        iniciarApp();
    </script>

    <!-- LOGICA PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('‚úÖ [PWA] Service Worker OK'))
                    .catch(err => console.error('‚ùå [PWA] Fall√≥ SW:', err));
            });
        }

        let deferredPrompt;
        const installBtn = document.getElementById('btn-install');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        });
    </script>

</body>
</html>
