<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Distribuidora L√°cteos</title>
    
    <!-- PWA Config -->
    <meta name="theme-color" content="#006A60">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <!-- Librer√≠as de Dise√±o (Tailwind + Iconos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* CONFIGURACI√ìN DE TEMA VISUAL */
        :root {
            --primary: #0066cc;
            --on-primary: #FFFFFF;
            --primary-container: #dcecfc;
            --surface: #F4FBF9;
            --surface-container: #ffffff;
            --text-main: #191C1B;
            --text-sub: #404947;
            --danger: #dc3545;
        }

        .dark-mode {
            --primary: #80bfff; 
            --on-primary: #003366;
            --primary-container: #004d99;
            --surface: #101413; 
            --surface-container: #1D201F; 
            --text-main: #E1E3DF;
            --text-sub: #BFC9C6;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--surface);
            color: var(--text-main);
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        /* Utilidades UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .md-card {
            background: var(--surface-container);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .md-card:active { transform: scale(0.98); }
        
        .md-search-bar {
            background: rgba(0,0,0,0.05);
            border-radius: 999px;
        }
        .dark-mode .md-search-bar { background: rgba(255,255,255,0.1); }

        /* Animaci√≥n de Sincronizaci√≥n */
        @keyframes pulse-red {
            0% { background-color: rgba(220, 53, 69, 1); }
            50% { background-color: rgba(220, 53, 69, 0.8); }
            100% { background-color: rgba(220, 53, 69, 1); }
        }
        .sync-banner {
            animation: pulse-red 2s infinite;
        }

        /* Dropdown Clientes */
        .client-dropdown {
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        
        /* Estilos Toggle Bulto */
        .toggle-switch {
            appearance: none;
            width: 36px;
            height: 20px;
            background: #ddd;
            border-radius: 20px;
            position: relative;
            outline: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch:checked {
            background: var(--primary);
        }
        .toggle-switch:checked::after {
            transform: translateX(16px);
        }
        .dark-mode .toggle-switch { background: #444; }
        .dark-mode .toggle-switch:checked { background: var(--primary); }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden" onclick="cerrarDropdowns(event)">

    <!-- 1. BARRA SUPERIOR (HEADER) -->
    <header class="shrink-0 z-30 flex flex-col gap-2 pt-2 pb-2 bg-[var(--surface)] transition-colors shadow-sm">
        
        <!-- Aviso Offline / Sincronizaci√≥n -->
        <div id="offline-status" class="hidden bg-yellow-400 text-black text-center text-xs font-bold py-1">
            ‚ö†Ô∏è MODO SIN CONEXI√ìN
        </div>
        <div id="sync-banner" onclick="sincronizarPendientes()" class="hidden sync-banner text-white text-center text-xs font-bold py-2 cursor-pointer mb-1 mx-4 rounded-lg">
            üì° Tienes <span id="sync-count">0</span> pedidos pendientes. ¬°Toca para enviar!
        </div>

        <div class="flex justify-between items-center px-4">
            <!-- Marca / Logo -->
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-[var(--primary)] flex items-center justify-center text-white shrink-0">
                    <i class="ph-fill ph-drop text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl leading-none text-[var(--text-main)]">Distribuidora</h1>
                    <!-- MOSTRAR NOMBRE DEL VENDEDOR EN HEADER -->
                    <span class="text-xs text-[var(--text-sub)] flex items-center gap-1">
                        <i class="ph-bold ph-user-circle"></i> 
                        <span id="header-vendedor-name">Sin Identificar</span>
                    </span>
                </div>
            </div>

            <!-- Botones Acci√≥n -->
            <div class="flex gap-1">
                <button id="btn-install" class="hidden px-3 py-1 bg-[var(--primary)] text-[var(--on-primary)] rounded-full text-xs font-bold shadow-md">
                    Instalar
                </button>
                <!-- BOT√ìN HISTORIAL -->
                <button onclick="toggleHistory()" class="w-10 h-10 rounded-full hover:bg-black/5 flex items-center justify-center text-[var(--text-main)]" title="Historial">
                    <i class="ph ph-clock-counter-clockwise text-2xl"></i>
                </button>
                <!-- BOT√ìN CONFIG -->
                <button onclick="toggleConfig()" class="w-10 h-10 rounded-full hover:bg-black/5 flex items-center justify-center text-[var(--text-main)]" title="Configuraci√≥n">
                    <i class="ph ph-gear text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- AREA DE B√öSQUEDAS -->
        <div class="px-4 space-y-2 pb-2">
            
            <!-- BUSCADOR INTELIGENTE DE CLIENTES -->
            <div class="relative z-50">
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="ph ph-users text-[var(--text-sub)] text-lg"></i>
                        </div>
                        
                        <input type="text" id="client-search-input" 
                            class="w-full bg-[var(--surface-container)] text-[var(--text-main)] p-2.5 pl-10 pr-24 rounded-xl border border-gray-200 dark:border-gray-700 text-sm outline-none focus:border-[var(--primary)] focus:ring-1 focus:ring-[var(--primary)] placeholder-gray-400 shadow-sm transition-all" 
                            placeholder="Buscar Cliente..." 
                            autocomplete="off"
                            oninput="filtrarClientes(this.value)"
                            onfocus="filtrarClientes(this.value, true)">
                        
                        <!-- ID Oculto del cliente seleccionado -->
                        <input type="hidden" id="selected-client-id">
                        <input type="hidden" id="selected-client-phone">
                        <input type="hidden" id="selected-client-name">

                        <!-- Botones Dentro del Input -->
                        <div class="absolute inset-y-0 right-0 flex items-center pr-2 gap-1">
                            <!-- NUEVO: Ver Detalles Cliente (solo visible al seleccionar) -->
                            <button id="info-client-btn" class="hidden text-blue-500 p-1 hover:bg-blue-100 dark:hover:bg-blue-900 rounded-full transition-colors" title="Ver Detalles" onclick="verDetallesDesdeInput()">
                                <i class="ph-bold ph-info text-lg"></i>
                            </button>
                            <!-- Limpiar Cliente -->
                            <button id="clear-client-btn" class="text-[var(--text-sub)] hidden p-1 hover:text-red-500 transition-colors" onclick="resetCliente()">
                                <i class="ph-fill ph-x-circle text-lg"></i>
                            </button>
                            <!-- Micr√≥fono Cliente -->
                            <button id="mic-client-btn" class="text-[var(--primary)] p-2 rounded-full hover:bg-black/5 transition-colors" onclick="startVoice('client-search-input', filtrarClientes, 'mic-client-btn')">
                                <i class="ph-bold ph-microphone text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- BOT√ìN NUEVO CLIENTE -->
                    <button onclick="toggleNewClientModal()" class="shrink-0 w-11 h-11 bg-[var(--primary)] text-white rounded-xl shadow-sm flex items-center justify-center active:scale-95 transition" title="Nuevo Cliente">
                        <i class="ph-bold ph-user-plus text-xl"></i>
                    </button>
                </div>

                <!-- Lista Desplegable -->
                <ul id="client-dropdown" class="absolute w-full mt-1 bg-[var(--surface-container)] border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl client-dropdown hidden">
                    <!-- Los clientes se inyectan aqu√≠ -->
                </ul>
            </div>

            <!-- BUSCADOR DE PRODUCTOS -->
            <div class="relative z-10 pt-2">
                <div class="md-search-bar h-12 flex items-center px-4 gap-2">
                    <i class="ph ph-magnifying-glass text-[var(--text-sub)] text-xl shrink-0"></i>
                    <input type="text" id="searchInput" placeholder="Buscar productos..." 
                           class="bg-transparent flex-1 outline-none text-[16px] text-[var(--text-main)] placeholder-[var(--text-sub)] min-w-0"
                           autocomplete="off">
                    
                    <!-- Limpiar Producto -->
                    <button id="clearSearch" class="hidden text-[var(--text-sub)] p-1 hover:text-red-500 shrink-0 transition-colors" onclick="clearInput()">
                        <i class="ph-fill ph-x-circle text-xl"></i>
                    </button>
                    <!-- Micr√≥fono Producto -->
                    <button id="mic-prod-btn" class="text-[var(--primary)] p-1 rounded-full hover:bg-black/5 shrink-0 transition-colors" onclick="startVoice('searchInput', renderizarProductos, 'mic-prod-btn')">
                        <i class="ph-bold ph-microphone text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. LISTA DE PRODUCTOS (MAIN) -->
    <main class="flex-1 overflow-y-auto no-scrollbar px-4 pb-32 pt-2" id="mainContainer">
        <div id="loadingState" class="flex flex-col items-center justify-center py-20 opacity-50 text-[var(--text-sub)]">
            <i class="ph-duotone ph-spinner-gap animate-spin text-4xl mb-2 text-[var(--primary)]"></i>
            <p>Conectando con la base de datos...</p>
        </div>
        
        <div id="productList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 pb-4">
            <!-- Aqu√≠ se inyectan las tarjetas -->
        </div>
    </main>

    <!-- 3. BARRA INFERIOR FLOTANTE (CARRITO) -->
    <div id="cartFooter" class="fixed bottom-0 left-0 w-full z-40 transform translate-y-full transition-transform duration-300">
        <div class="bg-[var(--surface-container)] border-t border-gray-200 dark:border-gray-800 rounded-t-[20px] shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-4 pb-6">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <!-- Click en texto abre detalle -->
                <div class="flex flex-col cursor-pointer" onclick="toggleCartModal()">
                    <div class="flex items-center gap-2">
                        <span class="bg-[var(--primary)] text-white text-[10px] font-bold px-2 py-0.5 rounded-md" id="itemCount">0</span>
                        <span class="text-xs text-[var(--text-sub)] font-medium">REVISAR <i class="ph-bold ph-caret-up"></i></span>
                    </div>
                    <div class="text-2xl font-bold text-[var(--primary)]" id="totalAmount">$0</div>
                </div>
                
                <!-- BOT√ìN CONFIRMAR DIRECTO -->
                <button id="btn-quick-submit" onclick="enviarPedido()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-500/30 active:scale-95 transition flex items-center gap-2">
                    Confirmar <i class="ph-bold ph-check-circle text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 4. MODAL DEL CARRITO (CHECKOUT - RESPONSIVE) -->
    <div id="cartModal" class="fixed inset-0 z-50 hidden flex justify-center items-end md:items-center">
        <!-- Backdrop oscurecido -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleCartModal()"></div>
        
        <!-- Contenido Modal: Estrecho y centrado en Desktop, Bottom Sheet en M√≥vil -->
        <div class="relative w-full md:max-w-2xl bg-[var(--surface-container)] rounded-t-[28px] md:rounded-[28px] h-[85vh] md:h-auto md:max-h-[85vh] flex flex-col shadow-2xl transition-transform overflow-hidden m-0 md:m-4">
            <!-- Header Modal -->
            <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center shrink-0">
                <h2 class="text-xl font-bold text-[var(--text-main)]">Resumen del Pedido</h2>
                <button onclick="toggleCartModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-[var(--text-main)] hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                    <i class="ph-bold ph-x md:block hidden"></i> <!-- X en desktop -->
                    <i class="ph-bold ph-caret-down md:hidden block"></i> <!-- Flecha abajo en m√≥vil -->
                </button>
            </div>

            <!-- Lista de Items en Carrito -->
            <div id="cartListContainer" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Items se generan aqu√≠ -->
            </div>

            <!-- Footer Modal (Con Notas) -->
            <div class="p-4 bg-[var(--surface)] border-t border-gray-100 dark:border-gray-800 shrink-0 pb-8 md:pb-4">
                
                <!-- CAMPO DE NOTAS -->
                <div class="mb-3">
                    <label class="text-xs font-bold text-[var(--text-sub)] mb-1 block flex items-center gap-1"><i class="ph-bold ph-note-pencil"></i> Notas del Pedido</label>
                    <textarea id="order-notes" rows="2" placeholder="Ej: Entregar por la tarde, cuidado perro..." 
                        class="w-full p-2.5 rounded-xl bg-[var(--surface-container)] border border-gray-200 dark:border-gray-700 text-sm outline-none focus:border-[var(--primary)] resize-none transition-all placeholder-gray-400"></textarea>
                </div>

                <div class="flex justify-between items-end mb-4">
                    <span class="text-sm text-[var(--text-sub)]">Total a Pagar</span>
                    <span class="text-3xl font-bold text-[var(--primary)]" id="modalTotal">$0</span>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <button id="btn-submit" onclick="enviarPedido()" class="h-14 bg-green-600 text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg active:scale-95 transition hover:bg-green-700">
                        <i class="ph-bold ph-check"></i> Confirmar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. MODAL DE HISTORIAL -->
    <div id="historyModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleHistory()"></div>
        <div class="relative bg-[var(--surface-container)] w-full max-w-lg rounded-2xl p-0 shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
            
            <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-[var(--surface-container)]">
                <h2 class="text-xl font-bold text-[var(--text-main)]">Historial</h2>
                <button onclick="toggleHistory()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-[var(--text-main)]">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>

            <div class="p-3 border-b border-gray-100 dark:border-gray-800 flex gap-2 bg-[var(--surface-container)]">
                <div class="flex-1 relative">
                    <input type="text" id="history-search-client" placeholder="Buscar cliente, ID o producto..." 
                           class="w-full bg-[var(--surface)] text-sm p-2 pl-3 pr-16 rounded-lg border border-gray-200 dark:border-gray-700 outline-none focus:border-[var(--primary)] text-[var(--text-main)]"
                           oninput="renderizarHistorial()">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-2 gap-1">
                        <button id="clear-history-btn" class="hidden text-[var(--text-sub)] p-1 hover:text-red-500 transition-colors" onclick="clearHistorySearch()">
                            <i class="ph-fill ph-x-circle text-lg"></i>
                        </button>
                        <button id="mic-history-btn" class="text-[var(--primary)] p-1 hover:bg-black/5 rounded-full transition-colors" onclick="startVoice('history-search-client', renderizarHistorial, 'mic-history-btn')">
                            <i class="ph-bold ph-microphone text-lg"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <input type="date" id="history-search-date" 
                           class="bg-[var(--surface)] text-sm p-2 rounded-lg border border-gray-200 dark:border-gray-700 outline-none focus:border-[var(--primary)] text-[var(--text-main)]"
                           onchange="renderizarHistorial()">
                </div>
            </div>

            <div id="historyListContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[var(--surface)]"></div>
            
            <div class="p-3 bg-[var(--surface-container)] text-center text-xs text-[var(--text-sub)] border-t border-gray-100 dark:border-gray-800">
                Mostrando √∫ltimos 50 pedidos.
            </div>
        </div>
    </div>

    <!-- 6. MODAL DE CONFIGURACI√ìN -->
    <div id="configModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleConfig()"></div>
        <div class="relative bg-[var(--surface-container)] w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-[var(--text-main)]">Ajustes</h2>
            
            <!-- CAMPO NOMBRE DEL VENDEDOR -->
            <div class="mb-4">
                <label class="block text-xs font-bold text-[var(--text-sub)] mb-1">Tu Nombre (Vendedor)</label>
                <div class="relative">
                    <input type="text" id="config-vendedor" 
                           class="w-full p-3 pl-9 rounded-xl bg-[var(--surface)] border border-gray-200 dark:border-gray-700 text-[var(--text-main)] outline-none focus:border-[var(--primary)] transition-colors text-sm font-medium" 
                           placeholder="Ej: Juan P√©rez" 
                           oninput="guardarNombreVendedor(this.value)">
                    <i class="ph-bold ph-user absolute left-3 top-3 text-[var(--text-sub)]"></i>
                </div>
                <p class="text-[10px] text-[var(--text-sub)] mt-1 ml-1">Este nombre se adjuntar√° a todos tus pedidos.</p>
            </div>

            <div class="flex items-center justify-between mb-4 pt-2 border-t border-gray-100 dark:border-gray-800">
                <span class="text-[var(--text-main)]">Modo Oscuro</span>
                <input type="checkbox" id="darkModeToggle" class="w-5 h-5" onchange="toggleDarkMode(this.checked)">
            </div>
            
            <button onclick="recargarDatos()" class="w-full py-3 bg-[var(--primary)] text-white rounded-xl font-medium mb-2">
                <i class="ph-bold ph-arrows-clockwise"></i> Recargar Datos
            </button>
            <button onclick="localStorage.clear()" class="w-full py-3 text-red-500 border border-red-200 rounded-xl font-medium text-sm" onmousedown="setTimeout(()=>location.reload(),200)">
                Restablecer App
            </button>
        </div>
    </div>

    <!-- 7. MODAL NUEVO CLIENTE -->
    <div id="newClientModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleNewClientModal()"></div>
        <div class="relative bg-[var(--surface-container)] w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-[var(--text-main)]">Nuevo Cliente</h2>
                <button onclick="toggleNewClientModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-[var(--text-main)]">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>
            
            <form id="formNewClient" onsubmit="guardarNuevoCliente(event)" class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-[var(--text-sub)] mb-1">Nombre Negocio *</label>
                    <input type="text" id="nc-negocio" required class="w-full p-3 rounded-xl bg-[var(--surface)] border border-gray-200 dark:border-gray-700 outline-none focus:border-[var(--primary)] text-[var(--text-main)]">
                </div>
                <div>
                    <label class="block text-xs font-bold text-[var(--text-sub)] mb-1">Nombre Due√±o/Contacto</label>
                    <input type="text" id="nc-dueno" class="w-full p-3 rounded-xl bg-[var(--surface)] border border-gray-200 dark:border-gray-700 outline-none focus:border-[var(--primary)] text-[var(--text-main)]">
                </div>
                <div>
                    <label class="block text-xs font-bold text-[var(--text-sub)] mb-1">Tel√©fono (WhatsApp)</label>
                    <input type="tel" id="nc-telefono" class="w-full p-3 rounded-xl bg-[var(--surface)] border border-gray-200 dark:border-gray-700 outline-none focus:border-[var(--primary)] text-[var(--text-main)]">
                </div>
                <div>
                    <label class="block text-xs font-bold text-[var(--text-sub)] mb-1">Direcci√≥n / Localidad</label>
                    <input type="text" id="nc-direccion" class="w-full p-3 rounded-xl bg-[var(--surface)] border border-gray-200 dark:border-gray-700 outline-none focus:border-[var(--primary)] text-[var(--text-main)]">
                </div>

                <!-- CAMPO GEOLOCALIZACI√ìN -->
                <div>
                    <label class="block text-xs font-bold text-[var(--text-sub)] mb-1">Ubicaci√≥n GPS</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="obtenerUbicacion()" id="btn-geo" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-[var(--text-main)] rounded-xl border border-gray-200 dark:border-gray-600 flex items-center justify-center gap-2 text-sm font-medium transition hover:bg-gray-200 dark:hover:bg-gray-600">
                            <i class="ph-bold ph-map-pin"></i> <span>Obtener Ubicaci√≥n</span>
                        </button>
                        <input type="hidden" id="nc-lat">
                        <input type="hidden" id="nc-lon">
                    </div>
                    <p id="geo-status" class="text-[10px] text-[var(--text-sub)] mt-1 ml-1 hidden"></p>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full py-3 bg-[var(--primary)] text-white rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition flex justify-center items-center gap-2">
                        <i class="ph-bold ph-floppy-disk"></i> Guardar y Seleccionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN ---
        // ‚ö†Ô∏è PEGA TU URL DE APPS SCRIPT AQU√ç (La que termina en /exec)
        const API_URL = "https://script.google.com/macros/s/AKfycbyD1aKqu_YRB7E3T5nxXiLnd0zx7lQ9lV0AUbpbjWmWgLMdVqiDwz4HXPYi-o9Lci0QSg/exec"; 

        // Variables de Estado
        let state = {
            productos: [],
            clientes: [],         // Clientes API + Locales
            clientesLocales: [],  // Solo los creados en el dispositivo
            carrito: {}, 
            config: { darkMode: false, nombreVendedor: "" }, // A√ëADIDO: nombreVendedor
            clienteSeleccionado: null,
            clienteVisualizado: null, // Para el modal de detalles
            historial: [],
            modoBulto: {} 
        };
        
        // --- MOTOR DE C√ÅLCULO ROBUSTO ---
        function parsearNumero(valor) {
            if (typeof valor === 'number') return Number.isFinite(valor) ? valor : 0;
            if (valor === null || valor === undefined || valor === '') return 0;

            // Soporta formatos: 1.500,50 | 1,500.50 | $ 1.500 | (1.200,00)
            let numero = String(valor).trim();
            const esNegativoPorParentesis = /^\(.*\)$/.test(numero);
            numero = numero.replace(/[()]/g, '').replace(/\s+/g, '').replace(/[^\d,.-]/g, '');
            if (!numero) return 0;

            const lastComma = numero.lastIndexOf(',');
            const lastDot = numero.lastIndexOf('.');

            if (lastComma !== -1 && lastDot !== -1) {
                // El √∫ltimo separador suele ser decimal.
                if (lastComma > lastDot) {
                    numero = numero.replace(/\./g, '').replace(/,/g, '.');
                } else {
                    numero = numero.replace(/,/g, '');
                }
            } else if (lastComma !== -1) {
                if (/^-?\d{1,3}(,\d{3})+$/.test(numero)) {
                    numero = numero.replace(/,/g, '');
                } else {
                    numero = numero.replace(/,/g, '.');
                }
            } else if (lastDot !== -1) {
                if (/^-?\d{1,3}(\.\d{3})+$/.test(numero)) {
                    numero = numero.replace(/\./g, '');
                }
            }

            const parsed = parseFloat(numero);
            if (!Number.isFinite(parsed)) return 0;
            return esNegativoPorParentesis ? -Math.abs(parsed) : parsed;
        }

        function enteroSeguro(valor, fallback = 0) {
            const num = parsearNumero(valor);
            if (!Number.isFinite(num)) return fallback;
            return Math.trunc(num);
        }

        function redondearMoneda(valor) {
            return Math.round((parsearNumero(valor) + Number.EPSILON) * 100) / 100;
        }

        // --- MANEJO SEGURO DE LOCALSTORAGE ---
        const SafeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); }
                catch(e) { console.warn("LocalStorage inaccesible:", e); return null; }
            },
            setItem: (key, val) => {
                try { localStorage.setItem(key, val); }
                catch(e) { console.warn("Error escribiendo LocalStorage:", e); }
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); }
                catch(e) { console.warn("Error borrando LocalStorage:", e); }
            },
            clear: () => {
                try { localStorage.clear(); }
                catch(e) { console.warn("Error limpiando LocalStorage:", e); }
            }
        };

        // --- 2. INICIO Y CARGA DE DATOS ---
        document.addEventListener('DOMContentLoaded', () => {
            cargarConfigLocal();
            iniciarApp();
            
            // Listeners Productos
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const val = e.target.value;
                renderizarProductos(val);
                const clearBtn = document.getElementById('clearSearch');
                if(val.length > 0) clearBtn.classList.remove('hidden');
                else clearBtn.classList.add('hidden');
            });
            
            window.addEventListener('online', actualizarEstadoConexion);
            window.addEventListener('offline', actualizarEstadoConexion);
        });

        async function iniciarApp() {
            actualizarEstadoConexion();
            verificarPendientes();
            cargarHistorialLocal(); 
            cargarClientesLocales(); // Cargar clientes creados offline/localmente

            try {
                const [resProd, resCli] = await Promise.all([
                    fetch(API_URL + "?action=getProductos"),
                    fetch(API_URL + "?action=getClientes")
                ]);

                state.productos = await resProd.json();
                const clientesAPI = await resCli.json();
                
                // Unificar Clientes API + Locales
                state.clientes = [...state.clientesLocales, ...clientesAPI];

                SafeStorage.setItem('db_productos', JSON.stringify(state.productos));
                SafeStorage.setItem('db_clientes', JSON.stringify(clientesAPI)); // Guardamos solo los de API para cache limpio

                renderizarUI();

            } catch (error) {
                console.log("Modo Offline activado");
                const cachedProd = SafeStorage.getItem('db_productos');
                const cachedCli = SafeStorage.getItem('db_clientes');

                if (cachedProd && cachedCli) {
                    try {
                        state.productos = JSON.parse(cachedProd);
                        const clientesAPI = JSON.parse(cachedCli);
                        state.clientes = [...state.clientesLocales, ...clientesAPI];
                        renderizarUI();
                    } catch(e) {
                         document.getElementById('loadingState').innerHTML = `<p class="text-red-500">Datos guardados corruptos. Reinicia la app.</p>`;
                    }
                } else {
                    document.getElementById('loadingState').innerHTML = `<p class="text-red-500">Sin conexi√≥n y sin datos guardados.</p>`;
                }
            }
        }

        function renderizarUI() {
            document.getElementById('loadingState').style.display = 'none';
            renderizarProductos();
        }

        // --- L√ìGICA DE CLIENTES LOCALES ---
        function cargarClientesLocales() {
            try {
                const stored = SafeStorage.getItem('db_clientes_locales');
                state.clientesLocales = stored ? JSON.parse(stored) : [];
            } catch(e) {
                state.clientesLocales = [];
            }
        }

        function toggleNewClientModal() {
            const modal = document.getElementById('newClientModal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')){
                document.getElementById('nc-negocio').focus();
                // Reset de estado GPS al abrir
                const btn = document.getElementById('btn-geo');
                const status = document.getElementById('geo-status');
                document.getElementById('nc-lat').value = "";
                document.getElementById('nc-lon').value = "";
                btn.className = "flex-1 py-3 bg-gray-100 dark:bg-gray-700 text-[var(--text-main)] rounded-xl border border-gray-200 dark:border-gray-600 flex items-center justify-center gap-2 text-sm font-medium transition hover:bg-gray-200 dark:hover:bg-gray-600";
                btn.innerHTML = `<i class="ph-bold ph-map-pin"></i> <span>Obtener Ubicaci√≥n</span>`;
                btn.disabled = false;
                status.classList.add('hidden');
            }
        }

        function obtenerUbicacion() {
            const btn = document.getElementById('btn-geo');
            const status = document.getElementById('geo-status');
            const latInput = document.getElementById('nc-lat');
            const lonInput = document.getElementById('nc-lon');

            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalizaci√≥n.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="ph-duotone ph-spinner animate-spin"></i> Obteniendo...`;
            status.textContent = "Buscando sat√©lites...";
            status.classList.remove('hidden');

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    latInput.value = lat;
                    lonInput.value = lon;

                    btn.className = "flex-1 py-3 bg-green-100 text-green-700 border border-green-200 rounded-xl flex items-center justify-center gap-2 text-sm font-bold";
                    btn.innerHTML = `<i class="ph-bold ph-check-circle"></i> Ubicaci√≥n Guardada`;
                    status.className = "text-[10px] text-green-600 mt-1 ml-1";
                    status.textContent = `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
                },
                (err) => {
                    console.error(err);
                    btn.disabled = false;
                    btn.innerHTML = `<i class="ph-bold ph-map-pin"></i> Reintentar`;
                    status.className = "text-[10px] text-red-500 mt-1 ml-1";
                    status.textContent = "Error: No se pudo obtener la ubicaci√≥n. Verifica permisos.";
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function guardarNuevoCliente(e) {
            e.preventDefault();
            
            const negocio = document.getElementById('nc-negocio').value.trim();
            const dueno = document.getElementById('nc-dueno').value.trim();
            const telefono = document.getElementById('nc-telefono').value.trim();
            const direccion = document.getElementById('nc-direccion').value.trim();
            const lat = document.getElementById('nc-lat').value;
            const lon = document.getElementById('nc-lon').value;

            if(!negocio) return;

            // Crear objeto cliente
            const nuevoCliente = {
                ID_Cliente: `NUEVO-${Date.now()}`, // ID √∫nico temporal
                Nombre_Negocio: negocio,
                Due√±o: dueno || "Sin Due√±o",
                Telefono: telefono,
                Direccion: direccion,
                Latitud: lat,
                Longitud: lon,
                EsLocal: true // Flag para identificarlo
            };

            // Guardar en estado local
            state.clientesLocales.unshift(nuevoCliente);
            SafeStorage.setItem('db_clientes_locales', JSON.stringify(state.clientesLocales));
            
            // Actualizar lista global
            state.clientes.unshift(nuevoCliente);

            // Seleccionar autom√°ticamente
            seleccionarCliente(nuevoCliente);
            
            // Reset y cerrar modal
            document.getElementById('formNewClient').reset();
            toggleNewClientModal();
            
            alert(`‚úÖ Cliente "${negocio}" creado y seleccionado.`);
        }

        // --- 2.1 FUNCIONES AUXILIARES DE B√öSQUEDA INTELIGENTE ---
        
        function normalizarTexto(str) {
            return (str || "").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function coincidenciaFlexible(textoDondeBuscar, terminoBusqueda) {
            if (!terminoBusqueda) return true;
            
            const palabrasBusqueda = normalizarTexto(terminoBusqueda).split(" ").filter(p => p.length > 0);
            const textoNormalizado = normalizarTexto(textoDondeBuscar);

            return palabrasBusqueda.every(palabra => textoNormalizado.includes(palabra));
        }

        // --- 2.2 RECONOCIMIENTO DE VOZ ---
        function startVoice(inputId, callbackFunction, btnId) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Tu navegador no soporta b√∫squeda por voz.");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'es-ES';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const btn = document.getElementById(btnId);
            const icon = btn.querySelector('i');
            const originalClass = icon.className;

            recognition.onstart = () => {
                icon.className = "ph-fill ph-circle text-red-500 animate-pulse text-xl"; // Indicador visual
            };

            recognition.onend = () => {
                icon.className = originalClass; // Restaurar icono
            };

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                const input = document.getElementById(inputId);
                
                input.value = speechResult;
                
                // Ejecutamos la b√∫squeda
                if (typeof callbackFunction === 'function') {
                    callbackFunction(speechResult);
                }
                
                input.dispatchEvent(new Event('input'));
                if(inputId === 'client-search-input') {
                   input.focus();
                }
            };
            
            recognition.onerror = (event) => {
                console.error("Error voz", event.error);
                icon.className = originalClass;
            };

            recognition.start();
        }


        // --- 2.5 SISTEMA DE B√öSQUEDA DE CLIENTES ---
        function filtrarClientes(filtro, mostrarTodos = false) {
            const dropdown = document.getElementById('client-dropdown');
            const clearBtn = document.getElementById('clear-client-btn');
            const infoBtn = document.getElementById('info-client-btn'); // Bot√≥n info

            // Ocultar info btn mientras buscamos
            infoBtn.classList.add('hidden');

            if (filtro && filtro.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            dropdown.innerHTML = "";
            
            if (!filtro && !mostrarTodos) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const filtrados = state.clientes.filter(c => {
                const textoCliente = `${c.Nombre_Negocio} ${c.Due√±o} ${c.ID_Cliente} ${c.Telefono || ""}`;
                return mostrarTodos || coincidenciaFlexible(textoCliente, filtro);
            });

            if (filtrados.length === 0) {
                dropdown.innerHTML = `<li class="p-3 text-[var(--text-sub)] text-sm text-center">No se encontraron clientes</li>`;
            } else {
                filtrados.slice(0, 50).forEach(c => { 
                    const li = document.createElement('li');
                    li.className = "p-3 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition flex items-center justify-between";
                    
                    // Distintivo para clientes locales
                    const badgeLocal = c.EsLocal ? `<span class="inline-block bg-blue-100 text-blue-800 text-[10px] px-1 rounded ml-2 font-bold">NUEVO</span>` : '';

                    // NUEVO: Estructura flexible con bot√≥n de info
                    // Evitamos que el clic en info seleccione al cliente usando stopPropagation en el futuro, pero aqui dividimos los divs
                    li.innerHTML = `
                        <div class="flex-1" onclick='seleccionarCliente(${JSON.stringify(c)})'>
                            <div class="font-medium text-[var(--text-main)]">${c.Nombre_Negocio} ${badgeLocal}</div>
                            <span class="text-xs text-[var(--text-sub)]">${c.Due√±o} | ID: ${c.ID_Cliente}</span>
                        </div>
                        <button onclick='verDetallesCliente(${JSON.stringify(c)})' class="p-2 text-[var(--primary)] hover:bg-blue-50 dark:hover:bg-blue-900 rounded-full ml-2 transition-colors">
                            <i class="ph-bold ph-info text-xl"></i>
                        </button>
                    `;
                    dropdown.appendChild(li);
                });
            }

            dropdown.classList.remove('hidden');
        }

        function seleccionarCliente(cliente) {
            state.clienteSeleccionado = cliente; // Guardamos ref
            document.getElementById('client-search-input').value = `${cliente.Nombre_Negocio} (${cliente.Due√±o})`;
            document.getElementById('selected-client-id').value = cliente.ID_Cliente;
            document.getElementById('selected-client-phone').value = cliente.Telefono || "";
            document.getElementById('selected-client-name').value = cliente.Nombre_Negocio;
            
            document.getElementById('client-dropdown').classList.add('hidden');
            document.getElementById('clear-client-btn').classList.remove('hidden');
            document.getElementById('info-client-btn').classList.remove('hidden'); // MOSTRAR BTN INFO
            document.getElementById('client-search-input').classList.add('border-[var(--primary)]', 'bg-blue-50', 'dark:bg-blue-900/20');
        }

        function resetCliente() {
            state.clienteSeleccionado = null;
            document.getElementById('client-search-input').value = "";
            document.getElementById('selected-client-id').value = "";
            document.getElementById('selected-client-phone').value = "";
            document.getElementById('selected-client-name').value = "";
            
            document.getElementById('clear-client-btn').classList.add('hidden');
            document.getElementById('info-client-btn').classList.add('hidden'); // OCULTAR BTN INFO
            document.getElementById('client-search-input').classList.remove('border-[var(--primary)]', 'bg-blue-50', 'dark:bg-blue-900/20');
            document.getElementById('client-dropdown').classList.add('hidden');
            document.getElementById('client-search-input').focus();
        }

        function cerrarDropdowns(e) {
            const container = document.getElementById('client-search-input').parentElement.parentElement;
            // Verificar si el click fue dentro del contenedor del buscador o en el modal
            const inModal = document.getElementById('newClientModal').contains(e.target);
            if (!container.contains(e.target) && !inModal) {
                document.getElementById('client-dropdown').classList.add('hidden');
            }
        }

        // --- NUEVAS FUNCIONES DE DETALLES Y COMPARTIR ---
        
        function verDetallesDesdeInput() {
            if(state.clienteSeleccionado) {
                verDetallesCliente(state.clienteSeleccionado);
            }
        }

        function verDetallesCliente(cliente) {
            state.clienteVisualizado = cliente;
            const content = document.getElementById('cd-content');
            
            // Construir HTML de detalles
            let html = `
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shrink-0">
                        <i class="ph-bold ph-storefront text-xl"></i>
                    </div>
                    <div>
                        <p class="font-bold text-lg">${cliente.Nombre_Negocio}</p>
                        <p class="text-[var(--text-sub)]">Due√±o: ${cliente.Due√±o || 'No registrado'}</p>
                    </div>
                </div>
                
                <div class="bg-[var(--surface)] p-3 rounded-xl border border-gray-100 dark:border-gray-800 space-y-2 mt-2">
                    <div class="flex gap-2">
                        <i class="ph-bold ph-phone text-[var(--text-sub)] mt-0.5"></i>
                        <span>${cliente.Telefono || 'Sin tel√©fono'}</span>
                    </div>
                    <div class="flex gap-2">
                        <i class="ph-bold ph-map-pin text-[var(--text-sub)] mt-0.5"></i>
                        <span>${cliente.Direccion || 'Sin direcci√≥n'}</span>
                    </div>
                    <div class="flex gap-2">
                        <i class="ph-bold ph-hash text-[var(--text-sub)] mt-0.5"></i>
                        <span class="text-xs font-mono bg-gray-200 dark:bg-gray-700 px-1 rounded">${cliente.ID_Cliente}</span>
                    </div>
                </div>
            `;

            // Estado de GPS
            if (cliente.Latitud && cliente.Longitud) {
                html += `
                    <div class="flex items-center gap-2 text-green-600 text-xs font-bold bg-green-50 dark:bg-green-900/20 p-2 rounded-lg">
                        <i class="ph-bold ph-check-circle"></i> Coordenadas GPS Registradas
                    </div>
                `;
            } else {
                html += `
                    <div class="flex items-center gap-2 text-red-500 text-xs font-bold bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">
                        <i class="ph-bold ph-warning"></i> Sin Coordenadas GPS
                    </div>
                `;
            }

            content.innerHTML = html;
            
            // Habilitar/Deshabilitar bot√≥n mapa
            const btnLoc = document.getElementById('btn-share-loc');
            if(!cliente.Latitud || !cliente.Longitud) {
                btnLoc.classList.add('opacity-50', 'cursor-not-allowed');
                btnLoc.onclick = null; 
            } else {
                btnLoc.classList.remove('opacity-50', 'cursor-not-allowed');
                btnLoc.onclick = compartirUbicacionActual;
            }

            toggleClientDetails();
        }

        function toggleClientDetails() {
            document.getElementById('clientDetailsModal').classList.toggle('hidden');
        }

        function compartirUbicacionActual() {
            const c = state.clienteVisualizado;
            if(!c || !c.Latitud) return;
            
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${c.Latitud},${c.Longitud}`;
            const msg = `üìç *Ubicaci√≥n Cliente*\nüè¢ ${c.Nombre_Negocio}\nüó∫Ô∏è Ver Mapa: ${mapsUrl}`;
            
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function compartirDatosActuales() {
            const c = state.clienteVisualizado;
            if(!c) return;
            
            let msg = `üìã *FICHA DE CLIENTE*\n\n`;
            msg += `üè¢ *Negocio:* ${c.Nombre_Negocio}\n`;
            msg += `üë§ *Due√±o:* ${c.Due√±o || 'N/A'}\n`;
            msg += `üìû *Tel:* ${c.Telefono || 'N/A'}\n`;
            msg += `üìç *Direcci√≥n:* ${c.Direccion || 'N/A'}\n`;
            msg += `üÜî *ID Sistema:* ${c.ID_Cliente}\n`;
            
            if(c.Latitud && c.Longitud) {
                msg += `\nüåê *GPS:* ${c.Latitud}, ${c.Longitud}\n`;
                msg += `üó∫Ô∏è *Mapa:* https://www.google.com/maps/search/?api=1&query=${c.Latitud},${c.Longitud}\n`;
            } else {
                msg += `\n‚ö†Ô∏è *GPS:* No registrado\n`;
            }

            msg += `\n_Generado por App Preventa_`;
            
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- RESTO DE L√ìGICA (PRODUCTOS, CARRITO, ENVIO) ---

        function esPesable(p) {
            const u = (p.Unidad || "").toLowerCase();
            if (u.includes('kg') || u.includes('kilo') || u.includes('gr') || u.includes('gramo')) return true;
            
            // FIX: Usamos parsearNumero
            const peso = parsearNumero(p.Peso_Promedio);
            if (peso > 0 && peso !== 1) return true;
            return false;
        }

        function obtenerConfigVenta(p) {
            const precioUnitario = Math.max(0, parsearNumero(p.Precio_Unitario));
            const pesoPromedio = Math.max(0.001, parsearNumero(p.Peso_Promedio) || 1);
            const unidadesPorBulto = Math.max(1, enteroSeguro(p.Unidades_Bulto, 1));
            const esProductoPesable = esPesable(p);
            const tieneBulto = unidadesPorBulto > 1;
            const enModoBulto = tieneBulto && !!state.modoBulto[p.ID_Producto];

            let factorPrecio = 1;
            if (esProductoPesable) {
                factorPrecio = enModoBulto ? (pesoPromedio * unidadesPorBulto) : pesoPromedio;
            } else {
                factorPrecio = enModoBulto ? unidadesPorBulto : 1;
            }

            return {
                precioUnitario,
                pesoPromedio,
                unidadesPorBulto,
                esProductoPesable,
                tieneBulto,
                enModoBulto,
                factorPrecio: Math.max(0, factorPrecio),
                precioVenta: redondearMoneda(precioUnitario * factorPrecio)
            };
        }

        function toggleModoVenta(idProducto) {
            state.modoBulto[idProducto] = !state.modoBulto[idProducto];
            renderizarProductos(document.getElementById('searchInput').value);
            actualizarCarritoUI();
        }

        function renderizarProductos(filtro = "") {
            const lista = document.getElementById('productList');
            lista.innerHTML = "";
            
            const filtrados = state.productos.filter(p => {
                const textoProd = `${p.Nombre} ${p.Categoria} ${p.ID_Producto}`;
                return coincidenciaFlexible(textoProd, filtro);
            });

            if (filtrados.length === 0) {
                lista.innerHTML = `<div class="col-span-full text-center py-10 text-[var(--text-sub)]">No se encontraron productos</div>`;
                return;
            }

            filtrados.forEach(p => {
                const qty = state.carrito[p.ID_Producto] || 0;
                const isSelected = qty > 0;
                
                const configVenta = obtenerConfigVenta(p);
                const { esProductoPesable, pesoPromedio, unidadesPorBulto, tieneBulto, enModoBulto, precioVenta: precioMostrar, precioUnitario } = configVenta; // Agregado precioUnitario

                let etiquetaUnidad = "Unitario"; 
                let etiquetaDetalle = "";

                if (esProductoPesable) {
                    // MODIFICADO: Mostrar precio x Kg
                    etiquetaUnidad = `$${precioUnitario.toLocaleString()} x Kg`; 

                    if (enModoBulto) {
                        etiquetaDetalle = `Bulto ~${(pesoPromedio * unidadesPorBulto).toFixed(1)}kg`;
                    } else {
                        etiquetaDetalle = `Pieza ~${pesoPromedio.toFixed(1)}kg`;
                    }
                } else {
                    etiquetaUnidad = "Unitario";
                    if (enModoBulto) {
                        etiquetaDetalle = `Pack ${unidadesPorBulto}u`;
                    }
                }
                
                const stockDisplay = (p.Stock_Actual !== undefined && p.Stock_Actual !== "") ? `Stock: ${p.Stock_Actual} ${p.Unidad || ''}` : "Stock: --";

                // === L√ìGICA DE IMAGEN ===
                const tieneImg = p.Imagen && p.Imagen.length > 5;
                const imgHtml = tieneImg
                    ? `<img src="${p.Imagen}" onerror="this.onerror=null;this.parentNode.innerHTML='<div class=\'w-20 h-20 bg-gray-100 flex items-center justify-center text-gray-300 rounded-lg\'><i class=\'ph-bold ph-image text-2xl\'></i></div>'" class="w-20 h-20 object-cover rounded-lg bg-white shrink-0 border border-gray-100">`
                    : `<div class="w-20 h-20 rounded-lg bg-gray-50 flex items-center justify-center shrink-0 text-gray-300 border border-gray-100"><i class="ph-bold ph-image text-2xl"></i></div>`;

                const card = document.createElement('div');
                card.className = `md-card p-3 relative flex flex-col justify-between h-full border-2 ${isSelected ? 'border-[var(--primary)] bg-blue-50 dark:bg-blue-900/20' : 'border-transparent'}`;
                
                let switchHtml = '';
                if (tieneBulto) {
                    switchHtml = `
                        <div class="flex items-center gap-2 mb-2 text-xs font-medium text-[var(--text-sub)] bg-gray-100 dark:bg-gray-800 p-1.5 rounded-lg w-fit">
                            <span class="${!enModoBulto ? 'text-[var(--primary)] font-bold' : ''}">${esProductoPesable ? 'Pieza' : 'Unit'}</span>
                            <input type="checkbox" class="toggle-switch" ${enModoBulto ? 'checked' : ''} onchange="toggleModoVenta('${p.ID_Producto}')">
                            <span class="${enModoBulto ? 'text-[var(--primary)] font-bold' : ''}">Bulto</span>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="flex gap-3 mb-2">
                        ${imgHtml} <!-- IMAGEN A LA IZQUIERDA -->
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <span class="text-[10px] font-bold text-[var(--text-sub)] bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded uppercase tracking-wider mb-1 block w-fit truncate max-w-[80px]">${p.Categoria}</span>
                                ${esProductoPesable ? `<span class="text-[10px] bg-yellow-100 text-yellow-800 px-1 rounded border border-yellow-200 whitespace-nowrap">Pesable</span>` : ''}
                            </div>
                            
                            <h3 class="text-sm font-medium text-[var(--text-main)] mt-1 leading-tight line-clamp-2">${p.Nombre}</h3>
                            <p class="text-xs text-[var(--text-sub)] mt-1">${stockDisplay}</p>
                        </div>
                    </div>

                    <div>
                        ${switchHtml}
                    </div>
                    
                    <div class="flex items-end justify-between mt-auto pt-2 border-t border-dashed border-gray-200 dark:border-gray-700">
                        <div class="flex flex-col">
                            <span class="text-lg font-bold text-[var(--primary)]">$${precioMostrar.toLocaleString()}</span>
                            <div class="flex flex-col leading-none">
                                <span class="text-[10px] text-[var(--text-sub)] font-black uppercase tracking-tighter">${etiquetaUnidad}</span>
                                <span class="text-[9px] text-[var(--text-sub)] italic">${etiquetaDetalle}</span>
                            </div>
                        </div>
                        
                        ${isSelected ? `
                        <div class="flex items-center bg-[var(--primary-container)] rounded-full px-1 py-1 gap-2">
                            <button onclick="cambiarCant('${p.ID_Producto}', -1)" class="w-7 h-7 bg-white dark:bg-black rounded-full flex items-center justify-center text-[var(--primary)] shadow-sm active:scale-90 transition"><i class="ph-bold ph-minus text-xs"></i></button>
                            
                            <span class="text-lg font-bold text-[var(--on-primary-container)] min-w-[1rem] text-center">${qty}</span>
                            
                            <button onclick="cambiarCant('${p.ID_Producto}', 1)" class="w-7 h-7 bg-[var(--primary)] rounded-full flex items-center justify-center text-white shadow-sm active:scale-90 transition"><i class="ph-bold ph-plus text-xs"></i></button>
                        </div>` : 
                        `<button onclick="cambiarCant('${p.ID_Producto}', 1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-[var(--primary)] flex items-center justify-center hover:bg-[var(--primary-container)] transition"><i class="ph-bold ph-plus"></i></button>`}
                    </div>
                `;
                lista.appendChild(card);
            });
        }

        // --- 3. L√ìGICA DEL CARRITO ---
        function cambiarCant(id, delta) {
            if (!state.carrito[id]) state.carrito[id] = 0;
            state.carrito[id] += enteroSeguro(delta, 0);
            state.carrito[id] = Math.max(0, enteroSeguro(state.carrito[id], 0));

            if (state.carrito[id] <= 0) delete state.carrito[id];

            const busqueda = document.getElementById('searchInput').value;
            renderizarProductos(busqueda);
            actualizarCarritoUI();
        }

        function calcularTotalItem(p, qty) {
            const cantidad = Math.max(0, enteroSeguro(qty, 0));
            const configVenta = obtenerConfigVenta(p);
            const { esProductoPesable, pesoPromedio, unidadesPorBulto, enModoBulto, precioVenta } = configVenta;

            const total = redondearMoneda(precioVenta * cantidad);

            let desc = "";
            if (enModoBulto) {
                desc = `${cantidad} Bulto${cantidad !== 1 ? 's' : ''}`;
                if (esProductoPesable) desc += ` (~${(pesoPromedio * unidadesPorBulto * cantidad).toFixed(1)}kg)`;
            } else {
                desc = `${cantidad} ${esProductoPesable ? 'Pieza' : 'Unidad'}${cantidad !== 1 ? 's' : ''}`;
                if (esProductoPesable) desc += ` (~${(pesoPromedio * cantidad).toFixed(1)}kg)`;
            }

            return { total, desc };
        }

        function actualizarCarritoUI() {
            const items = Object.entries(state.carrito);
            let totalGeneral = 0;
            let count = 0;

            items.forEach(([id, qty]) => {
                const p = state.productos.find(prod => prod.ID_Producto == id);
                if (p) {
                    const info = calcularTotalItem(p, qty);
                    totalGeneral = redondearMoneda(totalGeneral + info.total);
                    count += 1; 
                }
            });

            document.getElementById('itemCount').textContent = count;
            document.getElementById('totalAmount').textContent = `$${totalGeneral.toLocaleString()}`;
            document.getElementById('modalTotal').textContent = `$${totalGeneral.toLocaleString()}`;

            const footer = document.getElementById('cartFooter');
            if (Object.keys(state.carrito).length > 0) {
                footer.classList.remove('translate-y-full');
            } else {
                footer.classList.add('translate-y-full');
                document.getElementById('cartModal').classList.add('hidden');
            }
            renderizarListaModal();
        }

        function renderizarListaModal() {
            const contenedor = document.getElementById('cartListContainer');
            contenedor.innerHTML = '';

            Object.entries(state.carrito).forEach(([id, qty]) => {
                const p = state.productos.find(prod => prod.ID_Producto == id);
                if (!p) return;

                const info = calcularTotalItem(p, qty);
                
                // REPLICAMOS LOGICA DE VISUALIZACI√ìN DE CARD
                const configVenta = obtenerConfigVenta(p);
                const { esProductoPesable, pesoPromedio, unidadesPorBulto, enModoBulto, precioUnitario } = configVenta;

                let etiquetaUnidad = "Unitario"; 
                let etiquetaDetalle = "";

                if (esProductoPesable) {
                    etiquetaUnidad = `$${precioUnitario.toLocaleString()} x Kg`; 
                    if (enModoBulto) {
                        etiquetaDetalle = `Bulto ~${(pesoPromedio * unidadesPorBulto).toFixed(1)}kg`;
                    } else {
                        etiquetaDetalle = `Pieza ~${pesoPromedio.toFixed(1)}kg`;
                    }
                } else {
                    etiquetaUnidad = "Unitario";
                    if (enModoBulto) {
                        etiquetaDetalle = `Pack ${unidadesPorBulto}u`;
                    }
                }

                const el = document.createElement('div');
                el.className = "flex items-center justify-between p-3 bg-[var(--surface)] rounded-xl border border-gray-100 dark:border-gray-800";
                
                el.innerHTML = `
                    <div class="flex-1 pr-2">
                        <div class="text-sm font-medium text-[var(--text-main)] mb-1">${p.Nombre}</div>
                        
                        <!-- INFO EXTRA ESTILO CARD -->
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[10px] text-[var(--text-sub)] font-black uppercase tracking-tighter bg-gray-100 dark:bg-gray-700 px-1 rounded">${etiquetaUnidad}</span>
                            <span class="text-[9px] text-[var(--text-sub)] italic">${etiquetaDetalle}</span>
                        </div>

                        <div class="text-[var(--primary)] font-bold text-xs">${info.desc}</div>
                        <div class="text-xs text-[var(--text-sub)] mt-0.5">Total: $${info.total.toLocaleString()}</div>
                    </div>
                    <div class="flex items-center gap-3">
                         <button onclick="cambiarCant('${p.ID_Producto}', -1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-red-500"><i class="ph-bold ${qty<=1?'ph-trash':'ph-minus'}"></i></button>
                         <span class="font-bold text-[var(--text-main)] min-w-[1.5rem] text-center">${qty}</span>
                         <button onclick="cambiarCant('${p.ID_Producto}', 1)" class="w-8 h-8 rounded-full bg-[var(--primary)] flex items-center justify-center text-white"><i class="ph-bold ph-plus"></i></button>
                    </div>
                `;
                contenedor.appendChild(el);
            });
        }

        function toggleCartModal() {
            document.getElementById('cartModal').classList.toggle('hidden');
        }

        // --- 4. ENV√çO DE PEDIDOS ---
        async function enviarPedido() {
            const btn = document.getElementById('btn-submit');
            const btnQuick = document.getElementById('btn-quick-submit'); 
            
            const clienteId = document.getElementById('selected-client-id').value;
            const clienteNombre = document.getElementById('selected-client-name').value;
            const clienteTel = document.getElementById('selected-client-phone').value;
            const notas = document.getElementById('order-notes').value.trim(); 
            const vendedor = state.config.nombreVendedor || "Sin Identificar"; 
            
            if (!clienteId) {
                alert("‚ö†Ô∏è Por favor BUSCA y SELECCIONA un cliente arriba.");
                const modal = document.getElementById('cartModal');
                if(!modal.classList.contains('hidden')) { toggleCartModal(); }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                const input = document.getElementById('client-search-input');
                input.focus();
                input.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => input.classList.remove('ring-2', 'ring-red-500'), 2000);
                return;
            }

            const loadingText = `<i class="ph-duotone ph-spinner animate-spin text-xl"></i> Enviando...`;
            if(btn) { btn.disabled = true; btn.innerHTML = loadingText; }
            if(btnQuick) { btnQuick.disabled = true; btnQuick.innerHTML = loadingText; }

            const itemsArray = [];
            let totalVenta = 0;

            Object.entries(state.carrito).forEach(([id, qty]) => {
                const p = state.productos.find(prod => prod.ID_Producto == id);
                if (p) {
                    const info = calcularTotalItem(p, qty);
                    totalVenta = redondearMoneda(totalVenta + info.total);

                    itemsArray.push({
                        id: p.ID_Producto,
                        nombre: p.Nombre,
                        cantidad_sistema: qty,
                        detalle: info.desc,
                        subtotal: redondearMoneda(info.total)
                    });
                }
            });

            // RECUPERAR DATOS COMPLETOS DEL CLIENTE PARA EL ENV√çO
            const clienteFull = state.clientes.find(c => c.ID_Cliente === clienteId);

            const pedidoIdLocal = Date.now();

            const pedidoFinal = {
                id_interno: pedidoIdLocal, 
                cliente: {
                    id: clienteId,
                    nombre: clienteNombre,
                    telefono: clienteTel,
                    // Enviamos datos adicionales para que el backend pueda registrarlo autom√°ticamente
                    direccion: clienteFull ? clienteFull.Direccion : "",
                    dueno: clienteFull ? clienteFull.Due√±o : "",
                    latitud: clienteFull ? clienteFull.Latitud : "",
                    longitud: clienteFull ? clienteFull.Longitud : "",
                    esNuevo: clienteFull ? (clienteFull.EsLocal || false) : false
                },
                vendedor: vendedor,
                total: totalVenta,
                notas: notas,
                items: itemsArray,
                fechaLocal: new Date().toLocaleString()
            };

            if (navigator.onLine) {
                try {
                    await fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(pedidoFinal)
                    });
                    
                    guardarEnHistorial(pedidoFinal, 'Enviado');
                    manejarExito(pedidoFinal, clienteTel);
                    
                } catch (error) {
                    guardarPedidoOffline(pedidoFinal);
                }
            } else {
                guardarPedidoOffline(pedidoFinal);
            }
        }

        function manejarExito(pedido, telefono) {
            alert("‚úÖ Pedido Registrado Exitosamente");

            if(confirm("¬øDeseas enviar el comprobante por WhatsApp?")) {
                abrirWhatsapp(pedido, telefono);
            }
            
            location.reload();
        }

        function abrirWhatsapp(pedido, telefono) {
            const listaItems = pedido.items.map(i => `- ${i.detalle} ${i.nombre}`).join('\n');
            let mensaje = `Hola! Te confirmo pedido:\n${listaItems}\n*Total Estimado: $${pedido.total.toLocaleString()}*`;
            
            // NUEVO: Agregar nota al mensaje
            if(pedido.notas) {
                mensaje += `\n\nüìù *Nota:* ${pedido.notas}`;
            }

            // NUEVO: Firma vendedor
            const vendedor = state.config.nombreVendedor || "Vendedor";
            mensaje += `\n\n_Enviado por: ${vendedor}_`;

            const telLimpio = telefono ? telefono.replace(/[^0-9]/g, '') : "";
            const url = telLimpio ? `https://wa.me/${telLimpio}?text=${encodeURIComponent(mensaje)}` : `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        // --- 5. L√ìGICA DE HISTORIAL Y REPETIR PEDIDO ---
        function cargarHistorialLocal() {
            try {
                const stored = SafeStorage.getItem('db_historial');
                const parsed = stored ? JSON.parse(stored) : [];
                // Aseguramos que sea array, sino array vac√≠o
                state.historial = Array.isArray(parsed)
                    ? parsed.map(normalizarPedidoHistorial).filter(Boolean)
                    : [];
            } catch(e) {
                console.error("Error cargando historial, reseteando...", e);
                state.historial = [];
                SafeStorage.removeItem('db_historial');
            }
        }

        function normalizarPedidoHistorial(pedido) {
            if(!pedido || typeof pedido !== 'object') return null;

            const clienteOrigen = pedido.cliente || {};
            const nombreLegacy = pedido.cliente_nombre || pedido.nombreCliente || pedido.Nombre_Negocio || '';
            const telefonoLegacy = pedido.cliente_telefono || pedido.telefono || pedido.Telefono || '';
            const idLegacy = pedido.cliente_id || pedido.ID_Cliente || 'UNKNOWN';

            const cliente = {
                id: clienteOrigen.id || idLegacy,
                nombre: clienteOrigen.nombre || nombreLegacy || 'Cliente Desconocido',
                telefono: clienteOrigen.telefono || telefonoLegacy,
                direccion: clienteOrigen.direccion || '',
                dueno: clienteOrigen.dueno || '',
                latitud: clienteOrigen.latitud || '',
                longitud: clienteOrigen.longitud || '',
                esNuevo: Boolean(clienteOrigen.esNuevo)
            };

            if(!cliente.nombre) return null;

            return {
                ...pedido,
                id_interno: pedido.id_interno || Date.now(),
                cliente,
                items: Array.isArray(pedido.items) ? pedido.items : [],
                total: Number(pedido.total) || 0
            };
        }

        function guardarEnHistorial(pedido, estado = 'Enviado') {
            const historial = JSON.parse(SafeStorage.getItem('db_historial') || "[]");
            const pedidoNormalizado = normalizarPedidoHistorial({ ...pedido, estado });
            if(!pedidoNormalizado) return;
            historial.unshift(pedidoNormalizado);
            if(historial.length > 50) historial.pop();
            SafeStorage.setItem('db_historial', JSON.stringify(historial));
            state.historial = historial;
        }

        function toggleHistory() {
            const modal = document.getElementById('historyModal');
            if (modal.classList.contains('hidden')) {
                // Validaci√≥n DOM: Asegurar que los inputs existen antes de usarlos
                const inputClient = document.getElementById('history-search-client');
                const inputDate = document.getElementById('history-search-date');
                const btnClear = document.getElementById('clear-history-btn');
                
                if(inputClient) inputClient.value = '';
                if(inputDate) inputDate.value = '';
                if(btnClear) btnClear.classList.add('hidden'); 
                
                // PRIMERO ABRIMOS, LUEGO RENDERIZAMOS.
                // Si renderizar falla, al menos la ventana est√° abierta y vac√≠a.
                modal.classList.remove('hidden');
                
                try {
                    renderizarHistorial();
                } catch(e) {
                    console.error("Error global renderizando historial:", e);
                }
            } else {
                modal.classList.add('hidden');
            }
        }

        function clearHistorySearch() {
            document.getElementById('history-search-client').value = '';
            document.getElementById('clear-history-btn').classList.add('hidden');
            renderizarHistorial();
            document.getElementById('history-search-client').focus();
        }

        function renderizarHistorial() {
            const container = document.getElementById('historyListContainer');
            if (!container) return; // Validaci√≥n DOM

            container.innerHTML = "";
            
            // Validaci√≥n de Datos: Si no es array, lo forzamos a serlo y limpiamos
            if (!Array.isArray(state.historial)) {
                state.historial = [];
            }
            
            // Safe access to inputs
            const inputClient = document.getElementById('history-search-client');
            const inputDate = document.getElementById('history-search-date');
            
            const filtroTexto = inputClient ? inputClient.value : "";
            const filtroFecha = inputDate ? inputDate.value : "";
            
            const clearHistBtn = document.getElementById('clear-history-btn');
            if(clearHistBtn) {
                 if(filtroTexto && filtroTexto.length > 0) clearHistBtn.classList.remove('hidden');
                 else clearHistBtn.classList.add('hidden');
            }

            // --- FILTRO SEGURO ---
            // Usamos un array intermedio para no romper el filter original si hay datos malos
            let historialFiltrado = [];
            try {
                historialFiltrado = state.historial.filter(p => {
                    if(!p || !p.cliente) return false; // Descarte silencioso de basura
                    
                    const nombresProductos = (p.items || []).map(i => i ? (i.nombre || '') : '').join(" ");
                    const textoPedido = `${p.cliente.nombre || 'Cliente'} ${p.id_interno} ${p.total} ${nombresProductos}`;
                    const coincideTexto = coincidenciaFlexible(textoPedido, filtroTexto);
                    
                    let coincideFecha = true;
                    if(filtroFecha) {
                        try {
                            const fechaPedido = new Date(p.id_interno);
                            if(isNaN(fechaPedido.getTime())) return false;
                            
                            const partesFecha = filtroFecha.split('-');
                            const anioF = parseInt(partesFecha[0]);
                            const mesF = parseInt(partesFecha[1]) - 1; 
                            const diaF = parseInt(partesFecha[2]);

                            coincideFecha = (
                                fechaPedido.getFullYear() === anioF &&
                                fechaPedido.getMonth() === mesF &&
                                fechaPedido.getDate() === diaF
                            );
                        } catch(e) { return false; }
                    }
                    return coincideTexto && coincideFecha;
                });
            } catch (errFilter) {
                console.error("Error filtrando historial", errFilter);
                historialFiltrado = [];
            }

            if (historialFiltrado.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-[var(--text-sub)] opacity-70">No hay ventas que coincidan.</div>`;
                return;
            }

            // --- RENDERIZADO "ITEM POR ITEM" (Aislado) ---
            historialFiltrado.forEach(p => {
                try {
                    // Si un item falla, solo ese item se deja de mostrar
                    const el = document.createElement('div');
                    el.className = "bg-[var(--surface-container)] border border-gray-100 dark:border-gray-800 rounded-xl p-3 shadow-sm";
                    
                    const esPendiente = p.estado === 'Pendiente';
                    const statusColor = esPendiente 
                        ? 'text-yellow-700 bg-yellow-100 border border-yellow-200' 
                        : 'text-green-700 bg-green-100 border border-green-200';
                    
                    const iconoEstado = esPendiente ? '<i class="ph-bold ph-clock"></i>' : '<i class="ph-bold ph-check-circle"></i>';

                    const notasHtml = p.notas ? `
                        <div class="mt-2 text-xs bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200 p-2 rounded-lg border border-yellow-100 dark:border-yellow-800 flex gap-1 items-start">
                            <i class="ph-fill ph-note-pencil mt-0.5 shrink-0"></i>
                            <span class="italic">"${p.notas}"</span>
                        </div>` : '';

                    const nombreCliente = p.cliente.nombre || 'Cliente Desconocido';
                    const fecha = p.fechaLocal || 'Fecha desconocida';
                    const total = p.total ? p.total.toLocaleString() : '0';
                    const itemsCount = p.items ? p.items.length : 0;
                    
                    // SANEAMIENTO DE ID: Aseguramos que sea un string seguro para onclick
                    const safeId = String(p.id_interno).replace(/[^a-zA-Z0-9-]/g, '');

                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-[var(--text-main)] text-sm">${nombreCliente}</div>
                                <div class="text-xs text-[var(--text-sub)]">${fecha}</div>
                            </div>
                            <span class="text-xs font-bold px-2 py-1 rounded-md flex items-center gap-1 ${statusColor}">
                                ${iconoEstado} ${p.estado || 'Estado desc.'}
                            </span>
                        </div>
                        
                        ${notasHtml}

                        <div class="flex justify-between items-end border-t border-gray-100 dark:border-gray-700 pt-2 mt-2">
                            <div class="text-xs text-[var(--text-sub)]">${itemsCount} productos</div>
                            <div class="font-bold text-[var(--primary)]">$${total}</div>
                        </div>
                        <div class="mt-2 pt-2 flex gap-2">
                            <button onclick='repetirPedido("${safeId}")' class="flex-1 bg-[var(--primary)] text-white text-xs py-2 rounded-lg font-medium flex items-center justify-center gap-1 hover:opacity-90 transition">
                                <i class="ph-bold ph-arrows-clockwise"></i> Repetir
                            </button>
                            <button onclick='abrirWhatsappHistorial("${safeId}")' class="flex-1 bg-green-500 text-white text-xs py-2 rounded-lg font-medium flex items-center justify-center gap-1 hover:bg-green-600 transition">
                                <i class="ph-bold ph-whatsapp-logo"></i> Reenviar
                            </button>
                        </div>
                    `;
                    container.appendChild(el);
                } catch(itemErr) {
                    console.error("Item corrupto ignorado:", itemErr);
                }
            });
        }
        
        // --- 5.1 FUNCIONES FALTANTES A√ëADIDAS ---

        function repetirPedido(idPedido) {
            const pedido = state.historial.find(p => String(p.id_interno) === String(idPedido));
            if (!pedido) return;

            if (!confirm(`¬øCargar el pedido de ${pedido.cliente.nombre} al carrito actual? Se reemplazar√°n los items actuales.`)) return;

            // 1. Limpiar carrito actual
            state.carrito = {};

            // 2. Reconstruir carrito desde items del historial
            if(pedido.items && Array.isArray(pedido.items)) {
                pedido.items.forEach(item => {
                    state.carrito[item.id] = item.cantidad_sistema;
                });
            }

            // 3. Restaurar Cliente Seleccionado (Mapeo Inverso)
            const clienteHistorial = pedido.cliente;
            if(clienteHistorial) {
                const clienteRestaurado = {
                    ID_Cliente: clienteHistorial.id || "UNKNOWN",
                    Nombre_Negocio: clienteHistorial.nombre || "Desconocido",
                    Telefono: clienteHistorial.telefono || "",
                    Direccion: clienteHistorial.direccion || "",
                    Due√±o: clienteHistorial.dueno || "",
                    Latitud: clienteHistorial.latitud || "",
                    Longitud: clienteHistorial.longitud || "",
                    EsLocal: clienteHistorial.esNuevo || false
                };
                seleccionarCliente(clienteRestaurado);
            }

            // 4. Actualizar toda la interfaz
            const busqueda = document.getElementById('searchInput').value;
            renderizarProductos(busqueda);
            actualizarCarritoUI();
            
            // 5. UX: Cerrar historial y mostrar carrito
            toggleHistory();
            setTimeout(() => {
                toggleCartModal();
                alert("üõí Carrito restaurado con √©xito.");
            }, 300);
        }

        function abrirWhatsappHistorial(idPedido) {
            const pedido = state.historial.find(p => String(p.id_interno) === String(idPedido));
            if (!pedido || !pedido.cliente) return;
            
            // Reutilizamos la l√≥gica existente de WhatsApp
            abrirWhatsapp(pedido, pedido.cliente.telefono);
        }

        // --- 6. OFFLINE & SYNC ---
        function actualizarEstadoConexion() {
            const offlineBanner = document.getElementById('offline-status');
            if (!navigator.onLine) {
                offlineBanner.classList.remove('hidden');
            } else {
                offlineBanner.classList.add('hidden');
                verificarPendientes();
            }
        }

        function guardarPedidoOffline(pedido) {
            const pendientes = JSON.parse(SafeStorage.getItem('cola_pedidos') || "[]");
            pendientes.push(pedido);
            SafeStorage.setItem('cola_pedidos', JSON.stringify(pendientes));
            
            guardarEnHistorial(pedido, 'Pendiente');

            alert("üì∂ SIN CONEXI√ìN: Pedido guardado en el celular.\nSe enviar√° cuando recuperes se√±al.");
            location.reload();
        }

        function verificarPendientes() {
            const pendientes = JSON.parse(SafeStorage.getItem('cola_pedidos') || "[]");
            const banner = document.getElementById('sync-banner');
            if (pendientes.length > 0) {
                banner.classList.remove('hidden');
                document.getElementById('sync-count').textContent = pendientes.length;
            } else {
                banner.classList.add('hidden');
            }
        }

        async function sincronizarPendientes() {
            const pendientes = JSON.parse(SafeStorage.getItem('cola_pedidos') || "[]");
            if (pendientes.length === 0 || !navigator.onLine) return;

            if(!confirm(`¬øEnviar los ${pendientes.length} pedidos pendientes ahora?`)) return;

            const banner = document.getElementById('sync-banner');
            banner.textContent = "üì° Enviando... espera...";

            let enviados = 0;
            const errores = [];

            let historial = JSON.parse(SafeStorage.getItem('db_historial') || "[]");

            for (const pedido of pendientes) {
                try {
                    await fetch(API_URL, { method: "POST", body: JSON.stringify(pedido) });
                    enviados++;
                    
                    const idx = historial.findIndex(h => h.id_interno === pedido.id_interno);
                    if(idx !== -1) {
                        historial[idx].estado = 'Enviado';
                    } else {
                        pedido.estado = 'Enviado';
                        historial.unshift(pedido);
                    }

                } catch (e) {
                    errores.push(pedido);
                }
            }
            
            SafeStorage.setItem('db_historial', JSON.stringify(historial));
            state.historial = historial;

            SafeStorage.setItem('cola_pedidos', JSON.stringify(errores));
            alert(`Sincronizaci√≥n: ${enviados} enviados, ${errores.length} fallidos.`);
            location.reload();
        }

        // --- 7. UTILS & UI CONFIG ---
        function clearInput() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.add('hidden');
            renderizarProductos();
        }

        function toggleConfig() {
            document.getElementById('configModal').classList.toggle('hidden');
        }

        function toggleDarkMode(isDark) {
            state.config.darkMode = isDark;
            SafeStorage.setItem('app_config', JSON.stringify(state.config));
            if(isDark) document.body.classList.add('dark-mode');
            else document.body.classList.remove('dark-mode');
        }

        // NUEVO: Guardar nombre vendedor
        function guardarNombreVendedor(nombre) {
            state.config.nombreVendedor = nombre;
            SafeStorage.setItem('app_config', JSON.stringify(state.config));
            
            // Actualizar UI en tiempo real
            const display = document.getElementById('header-vendedor-name');
            if(display) display.textContent = nombre || "Sin Identificar";
        }

        function cargarConfigLocal() {
            const cfg = JSON.parse(SafeStorage.getItem('app_config') || '{}');
            state.config = { ...state.config, ...cfg };
            if (state.config.darkMode) {
                document.getElementById('darkModeToggle').checked = true;
                document.body.classList.add('dark-mode');
            }
            
            // Cargar nombre vendedor
            if(state.config.nombreVendedor) {
                document.getElementById('config-vendedor').value = state.config.nombreVendedor;
                document.getElementById('header-vendedor-name').textContent = state.config.nombreVendedor;
            }
        }
        
        function recargarDatos() {
            SafeStorage.removeItem('db_productos');
            SafeStorage.removeItem('db_clientes');
            location.reload();
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('btn-install').classList.remove('hidden');
        });
        document.getElementById('btn-install').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                document.getElementById('btn-install').classList.add('hidden');
            }
        });
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

    </script>
</body>
</html>
