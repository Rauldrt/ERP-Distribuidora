<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Distribuidora L√°cteos</title>
    
    <!-- PWA Config -->
    <meta name="theme-color" content="#006A60">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <!-- Librer√≠as de Dise√±o (Tailwind + Iconos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* CONFIGURACI√ìN DE TEMA VISUAL */
        :root {
            --primary: #0066cc;
            --on-primary: #FFFFFF;
            --primary-container: #dcecfc;
            --surface: #F4FBF9;
            --surface-container: #ffffff;
            --text-main: #191C1B;
            --text-sub: #404947;
            --danger: #dc3545;
        }

        .dark-mode {
            --primary: #80bfff; 
            --on-primary: #003366;
            --primary-container: #004d99;
            --surface: #101413; 
            --surface-container: #1D201F; 
            --text-main: #E1E3DF;
            --text-sub: #BFC9C6;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--surface);
            color: var(--text-main);
            transition: background-color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        /* Utilidades UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .md-card {
            background: var(--surface-container);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .md-card:active { transform: scale(0.98); }
        
        .md-search-bar {
            background: rgba(0,0,0,0.05);
            border-radius: 999px;
        }
        .dark-mode .md-search-bar { background: rgba(255,255,255,0.1); }

        /* Animaci√≥n de Sincronizaci√≥n */
        @keyframes pulse-red {
            0% { background-color: rgba(220, 53, 69, 1); }
            50% { background-color: rgba(220, 53, 69, 0.8); }
            100% { background-color: rgba(220, 53, 69, 1); }
        }
        .sync-banner {
            animation: pulse-red 2s infinite;
        }

        /* Dropdown Clientes */
        .client-dropdown {
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        
        /* Estilos Toggle Bulto */
        .toggle-switch {
            appearance: none;
            width: 36px;
            height: 20px;
            background: #ddd;
            border-radius: 20px;
            position: relative;
            outline: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch:checked {
            background: var(--primary);
        }
        .toggle-switch:checked::after {
            transform: translateX(16px);
        }
        .dark-mode .toggle-switch { background: #444; }
        .dark-mode .toggle-switch:checked { background: var(--primary); }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden" onclick="cerrarDropdowns(event)">

    <!-- 1. BARRA SUPERIOR (HEADER) -->
    <header class="shrink-0 z-30 flex flex-col gap-2 pt-2 pb-2 bg-[var(--surface)] transition-colors shadow-sm">
        
        <!-- Aviso Offline / Sincronizaci√≥n -->
        <div id="offline-status" class="hidden bg-yellow-400 text-black text-center text-xs font-bold py-1">
            ‚ö†Ô∏è MODO SIN CONEXI√ìN
        </div>
        <div id="sync-banner" onclick="sincronizarPendientes()" class="hidden sync-banner text-white text-center text-xs font-bold py-2 cursor-pointer mb-1 mx-4 rounded-lg">
            üì° Tienes <span id="sync-count">0</span> pedidos pendientes. ¬°Toca para enviar!
        </div>

        <div class="flex justify-between items-center px-4">
            <!-- Marca / Logo -->
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-[var(--primary)] flex items-center justify-center text-white shrink-0">
                    <i class="ph-fill ph-drop text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl leading-none text-[var(--text-main)]">Distribuidora</h1>
                    <span class="text-xs text-[var(--text-sub)]">Gesti√≥n de Pedidos</span>
                </div>
            </div>

            <!-- Botones Acci√≥n -->
            <div class="flex gap-1">
                <button id="btn-install" class="hidden px-3 py-1 bg-[var(--primary)] text-[var(--on-primary)] rounded-full text-xs font-bold shadow-md">
                    Instalar
                </button>
                <!-- BOT√ìN HISTORIAL -->
                <button onclick="toggleHistory()" class="w-10 h-10 rounded-full hover:bg-black/5 flex items-center justify-center text-[var(--text-main)]" title="Historial">
                    <i class="ph ph-clock-counter-clockwise text-2xl"></i>
                </button>
                <!-- BOT√ìN CONFIG -->
                <button onclick="toggleConfig()" class="w-10 h-10 rounded-full hover:bg-black/5 flex items-center justify-center text-[var(--text-main)]" title="Configuraci√≥n">
                    <i class="ph ph-gear text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- AREA DE B√öSQUEDAS -->
        <div class="px-4 space-y-2 pb-2">
            
            <!-- BUSCADOR INTELIGENTE DE CLIENTES -->
            <div class="relative z-50">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="ph ph-users text-[var(--text-sub)] text-lg"></i>
                    </div>
                    
                    <input type="text" id="client-search-input" 
                        class="w-full bg-[var(--surface-container)] text-[var(--text-main)] p-2.5 pl-10 pr-20 rounded-xl border border-gray-200 dark:border-gray-700 text-sm outline-none focus:border-[var(--primary)] focus:ring-1 focus:ring-[var(--primary)] placeholder-gray-400 shadow-sm transition-all" 
                        placeholder="Buscar Cliente (Voz o Texto)" 
                        autocomplete="off"
                        oninput="filtrarClientes(this.value)"
                        onfocus="filtrarClientes(this.value, true)">
                    
                    <!-- ID Oculto del cliente seleccionado -->
                    <input type="hidden" id="selected-client-id">
                    <input type="hidden" id="selected-client-phone">
                    <input type="hidden" id="selected-client-name">

                    <!-- Botones Dentro del Input -->
                    <div class="absolute inset-y-0 right-0 flex items-center pr-2 gap-1">
                        <!-- Limpiar Cliente -->
                        <button id="clear-client-btn" class="text-[var(--text-sub)] hidden p-1 hover:text-red-500 transition-colors" onclick="resetCliente()">
                            <i class="ph-fill ph-x-circle text-lg"></i>
                        </button>
                        <!-- Micr√≥fono Cliente -->
                        <button id="mic-client-btn" class="text-[var(--primary)] p-2 rounded-full hover:bg-black/5 transition-colors" onclick="startVoice('client-search-input', filtrarClientes, 'mic-client-btn')">
                            <i class="ph-bold ph-microphone text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- Lista Desplegable -->
                <ul id="client-dropdown" class="absolute w-full mt-1 bg-[var(--surface-container)] border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl client-dropdown hidden">
                    <!-- Los clientes se inyectan aqu√≠ -->
                </ul>
            </div>

            <!-- BUSCADOR DE PRODUCTOS -->
            <div class="relative z-10">
                <div class="md-search-bar h-12 flex items-center px-4 gap-2">
                    <i class="ph ph-magnifying-glass text-[var(--text-sub)] text-xl shrink-0"></i>
                    <input type="text" id="searchInput" placeholder="Buscar productos..." 
                           class="bg-transparent flex-1 outline-none text-[16px] text-[var(--text-main)] placeholder-[var(--text-sub)] min-w-0"
                           autocomplete="off">
                    
                    <!-- Limpiar Producto -->
                    <button id="clearSearch" class="hidden text-[var(--text-sub)] p-1 hover:text-red-500 shrink-0 transition-colors" onclick="clearInput()">
                        <i class="ph-fill ph-x-circle text-xl"></i>
                    </button>
                    <!-- Micr√≥fono Producto -->
                    <button id="mic-prod-btn" class="text-[var(--primary)] p-1 rounded-full hover:bg-black/5 shrink-0 transition-colors" onclick="startVoice('searchInput', renderizarProductos, 'mic-prod-btn')">
                        <i class="ph-bold ph-microphone text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. LISTA DE PRODUCTOS (MAIN) -->
    <main class="flex-1 overflow-y-auto no-scrollbar px-4 pb-32 pt-2" id="mainContainer">
        <div id="loadingState" class="flex flex-col items-center justify-center py-20 opacity-50 text-[var(--text-sub)]">
            <i class="ph-duotone ph-spinner-gap animate-spin text-4xl mb-2 text-[var(--primary)]"></i>
            <p>Conectando con la base de datos...</p>
        </div>
        
        <div id="productList" class="grid grid-cols-1 md:grid-cols-2 gap-3 pb-4">
            <!-- Aqu√≠ se inyectan las tarjetas -->
        </div>
    </main>

    <!-- 3. BARRA INFERIOR FLOTANTE (CARRITO) -->
    <div id="cartFooter" class="fixed bottom-0 left-0 w-full z-40 transform translate-y-full transition-transform duration-300">
        <div class="bg-[var(--surface-container)] border-t border-gray-200 dark:border-gray-800 rounded-t-[20px] shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-4 pb-6">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <!-- Click en texto abre detalle -->
                <div class="flex flex-col cursor-pointer" onclick="toggleCartModal()">
                    <div class="flex items-center gap-2">
                        <span class="bg-[var(--primary)] text-white text-[10px] font-bold px-2 py-0.5 rounded-md" id="itemCount">0</span>
                        <span class="text-xs text-[var(--text-sub)] font-medium">REVISAR <i class="ph-bold ph-caret-up"></i></span>
                    </div>
                    <div class="text-2xl font-bold text-[var(--primary)]" id="totalAmount">$0</div>
                </div>
                
                <!-- BOT√ìN CONFIRMAR DIRECTO -->
                <button id="btn-quick-submit" onclick="enviarPedido()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-500/30 active:scale-95 transition flex items-center gap-2">
                    Confirmar <i class="ph-bold ph-check-circle text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 4. MODAL DEL CARRITO (CHECKOUT) -->
    <div id="cartModal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop oscurecido -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleCartModal()"></div>
        
        <!-- Contenido Modal -->
        <div class="absolute bottom-0 left-0 w-full bg-[var(--surface-container)] rounded-t-[28px] h-[85vh] flex flex-col shadow-2xl transition-transform">
            <!-- Header Modal -->
            <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                <h2 class="text-xl font-bold text-[var(--text-main)]">Resumen del Pedido</h2>
                <button onclick="toggleCartModal()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-[var(--text-main)]">
                    <i class="ph-bold ph-caret-down"></i>
                </button>
            </div>

            <!-- Lista de Items en Carrito -->
            <div id="cartListContainer" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Items se generan aqu√≠ -->
            </div>

            <!-- Footer Modal -->
            <div class="p-4 bg-[var(--surface)] border-t border-gray-100 dark:border-gray-800 pb-8">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-sm text-[var(--text-sub)]">Total a Pagar</span>
                    <span class="text-3xl font-bold text-[var(--primary)]" id="modalTotal">$0</span>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <button id="btn-submit" onclick="enviarPedido()" class="h-14 bg-green-600 text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg active:scale-95 transition">
                        <i class="ph-bold ph-check"></i> Confirmar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. MODAL DE HISTORIAL (B√öSQUEDA FLEXIBLE + VOZ) -->
    <div id="historyModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleHistory()"></div>
        <div class="relative bg-[var(--surface-container)] w-full max-w-lg rounded-2xl p-0 shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
            
            <!-- Header del Modal -->
            <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-[var(--surface-container)]">
                <h2 class="text-xl font-bold text-[var(--text-main)]">Historial</h2>
                <button onclick="toggleHistory()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-[var(--text-main)]">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>

            <!-- Barra de Filtros -->
            <div class="p-3 border-b border-gray-100 dark:border-gray-800 flex gap-2 bg-[var(--surface-container)]">
                <div class="flex-1 relative">
                    <input type="text" id="history-search-client" placeholder="Buscar por voz..." 
                           class="w-full bg-[var(--surface)] text-sm p-2 pl-3 pr-16 rounded-lg border border-gray-200 dark:border-gray-700 outline-none focus:border-[var(--primary)] text-[var(--text-main)]"
                           oninput="renderizarHistorial()">
                    
                    <div class="absolute inset-y-0 right-0 flex items-center pr-2 gap-1">
                        <!-- Limpiar Historial -->
                        <button id="clear-history-btn" class="hidden text-[var(--text-sub)] p-1 hover:text-red-500 transition-colors" onclick="clearHistorySearch()">
                            <i class="ph-fill ph-x-circle text-lg"></i>
                        </button>
                        <!-- Micr√≥fono Historial -->
                        <button id="mic-history-btn" class="text-[var(--primary)] p-1 hover:bg-black/5 rounded-full transition-colors" onclick="startVoice('history-search-client', renderizarHistorial, 'mic-history-btn')">
                            <i class="ph-bold ph-microphone text-lg"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <input type="date" id="history-search-date" 
                           class="bg-[var(--surface)] text-sm p-2 rounded-lg border border-gray-200 dark:border-gray-700 outline-none focus:border-[var(--primary)] text-[var(--text-main)]"
                           onchange="renderizarHistorial()">
                </div>
            </div>

            <!-- Lista de Historial -->
            <div id="historyListContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[var(--surface)]">
                <!-- Lista de historial -->
            </div>
            
            <div class="p-3 bg-[var(--surface-container)] text-center text-xs text-[var(--text-sub)] border-t border-gray-100 dark:border-gray-800">
                Mostrando √∫ltimos 50 pedidos.
            </div>
        </div>
    </div>

    <!-- 6. MODAL DE CONFIGURACI√ìN -->
    <div id="configModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleConfig()"></div>
        <div class="relative bg-[var(--surface-container)] w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-[var(--text-main)]">Ajustes</h2>
            
            <div class="flex items-center justify-between mb-4">
                <span class="text-[var(--text-main)]">Modo Oscuro</span>
                <input type="checkbox" id="darkModeToggle" class="w-5 h-5" onchange="toggleDarkMode(this.checked)">
            </div>
            
            <button onclick="recargarDatos()" class="w-full py-3 bg-[var(--primary)] text-white rounded-xl font-medium mb-2">
                <i class="ph-bold ph-arrows-clockwise"></i> Recargar Datos
            </button>
            <button onclick="localStorage.clear(); location.reload()" class="w-full py-3 text-red-500 border border-red-200 rounded-xl font-medium text-sm">
                Restablecer App
            </button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN ---
        // ‚ö†Ô∏è PEGA TU URL DE APPS SCRIPT AQU√ç (La que termina en /exec)
        const API_URL = "https://script.google.com/macros/s/AKfycbyD1aKqu_YRB7E3T5nxXiLnd0zx7lQ9lV0AUbpbjWmWgLMdVqiDwz4HXPYi-o9Lci0QSg/exec"; 

        // Variables de Estado
        let state = {
            productos: [],
            clientes: [],
            carrito: {}, 
            config: { darkMode: false },
            clienteSeleccionado: null,
            historial: [],
            modoBulto: {} // {ID_Producto: true/false}
        };

        // --- 2. INICIO Y CARGA DE DATOS ---
        document.addEventListener('DOMContentLoaded', () => {
            cargarConfigLocal();
            iniciarApp();
            
            // Listeners Productos
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const val = e.target.value;
                renderizarProductos(val);
                // Mostrar/Ocultar bot√≥n X de productos
                const clearBtn = document.getElementById('clearSearch');
                if(val.length > 0) clearBtn.classList.remove('hidden');
                else clearBtn.classList.add('hidden');
            });
            
            // Verificar conexi√≥n
            window.addEventListener('online', actualizarEstadoConexion);
            window.addEventListener('offline', actualizarEstadoConexion);
        });

        async function iniciarApp() {
            actualizarEstadoConexion();
            verificarPendientes();
            cargarHistorialLocal(); 

            try {
                const [resProd, resCli] = await Promise.all([
                    fetch(API_URL + "?action=getProductos"),
                    fetch(API_URL + "?action=getClientes")
                ]);

                state.productos = await resProd.json();
                state.clientes = await resCli.json();

                localStorage.setItem('db_productos', JSON.stringify(state.productos));
                localStorage.setItem('db_clientes', JSON.stringify(state.clientes));

                renderizarUI();

            } catch (error) {
                console.log("Modo Offline activado");
                const cachedProd = localStorage.getItem('db_productos');
                const cachedCli = localStorage.getItem('db_clientes');

                if (cachedProd && cachedCli) {
                    state.productos = JSON.parse(cachedProd);
                    state.clientes = JSON.parse(cachedCli);
                    renderizarUI();
                } else {
                    document.getElementById('loadingState').innerHTML = `<p class="text-red-500">Sin conexi√≥n y sin datos guardados.</p>`;
                }
            }
        }

        function renderizarUI() {
            document.getElementById('loadingState').style.display = 'none';
            renderizarProductos();
        }

        // --- 2.1 FUNCIONES AUXILIARES DE B√öSQUEDA INTELIGENTE ---
        
        function normalizarTexto(str) {
            return (str || "").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function coincidenciaFlexible(textoDondeBuscar, terminoBusqueda) {
            if (!terminoBusqueda) return true;
            
            const palabrasBusqueda = normalizarTexto(terminoBusqueda).split(" ").filter(p => p.length > 0);
            const textoNormalizado = normalizarTexto(textoDondeBuscar);

            return palabrasBusqueda.every(palabra => textoNormalizado.includes(palabra));
        }

        // --- 2.2 RECONOCIMIENTO DE VOZ ---
        function startVoice(inputId, callbackFunction, btnId) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Tu navegador no soporta b√∫squeda por voz.");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'es-ES';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const btn = document.getElementById(btnId);
            const icon = btn.querySelector('i');
            const originalClass = icon.className;

            recognition.onstart = () => {
                icon.className = "ph-fill ph-circle text-red-500 animate-pulse text-xl"; // Indicador visual
            };

            recognition.onend = () => {
                icon.className = originalClass; // Restaurar icono
            };

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                const input = document.getElementById(inputId);
                
                input.value = speechResult;
                
                // Ejecutamos la b√∫squeda
                if (typeof callbackFunction === 'function') {
                    callbackFunction(speechResult);
                }
                
                // Disparar evento input para que se actualicen los botones X
                input.dispatchEvent(new Event('input'));
                
                // Si es el buscador de clientes, activamos el foco
                if(inputId === 'client-search-input') {
                   input.focus();
                }
            };
            
            recognition.onerror = (event) => {
                console.error("Error voz", event.error);
                icon.className = originalClass;
            };

            recognition.start();
        }


        // --- 2.5 NUEVO SISTEMA DE B√öSQUEDA DE CLIENTES (FLEXIBLE) ---
        function filtrarClientes(filtro, mostrarTodos = false) {
            const dropdown = document.getElementById('client-dropdown');
            const clearBtn = document.getElementById('clear-client-btn');

            // Mostrar bot√≥n X si hay texto
            if (filtro && filtro.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            dropdown.innerHTML = "";
            
            if (!filtro && !mostrarTodos) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const filtrados = state.clientes.filter(c => {
                const textoCliente = `${c.Nombre_Negocio} ${c.Due√±o} ${c.ID_Cliente} ${c.Telefono || ""}`;
                return mostrarTodos || coincidenciaFlexible(textoCliente, filtro);
            });

            if (filtrados.length === 0) {
                dropdown.innerHTML = `<li class="p-3 text-[var(--text-sub)] text-sm text-center">No se encontraron clientes</li>`;
            } else {
                filtrados.slice(0, 50).forEach(c => { 
                    const li = document.createElement('li');
                    li.className = "p-3 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition flex flex-col";
                    li.innerHTML = `
                        <span class="font-medium text-[var(--text-main)]">${c.Nombre_Negocio}</span>
                        <span class="text-xs text-[var(--text-sub)]">${c.Due√±o} | ID: ${c.ID_Cliente}</span>
                    `;
                    li.onclick = () => seleccionarCliente(c);
                    dropdown.appendChild(li);
                });
            }

            dropdown.classList.remove('hidden');
        }

        function seleccionarCliente(cliente) {
            document.getElementById('client-search-input').value = `${cliente.Nombre_Negocio} (${cliente.Due√±o})`;
            document.getElementById('selected-client-id').value = cliente.ID_Cliente;
            document.getElementById('selected-client-phone').value = cliente.Telefono || "";
            document.getElementById('selected-client-name').value = cliente.Nombre_Negocio;
            
            document.getElementById('client-dropdown').classList.add('hidden');
            // Aseguramos que la X sea visible al seleccionar
            document.getElementById('clear-client-btn').classList.remove('hidden');
            
            document.getElementById('client-search-input').classList.add('border-[var(--primary)]', 'bg-blue-50', 'dark:bg-blue-900/20');
        }

        function resetCliente() {
            document.getElementById('client-search-input').value = "";
            document.getElementById('selected-client-id').value = "";
            document.getElementById('selected-client-phone').value = "";
            document.getElementById('selected-client-name').value = "";
            
            document.getElementById('clear-client-btn').classList.add('hidden');
            document.getElementById('client-search-input').classList.remove('border-[var(--primary)]', 'bg-blue-50', 'dark:bg-blue-900/20');
            document.getElementById('client-dropdown').classList.add('hidden');
            document.getElementById('client-search-input').focus();
        }

        function cerrarDropdowns(e) {
            const container = document.getElementById('client-search-input').parentElement.parentElement;
            if (!container.contains(e.target)) {
                document.getElementById('client-dropdown').classList.add('hidden');
            }
        }

        // --- RESTO DE L√ìGICA (PRODUCTOS, CARRITO, ENVIO) ---

        // Funci√≥n robusta de detecci√≥n (incluye peso > 0)
        function esPesable(p) {
            // Normalizar unidad
            const u = (p.Unidad || "").toLowerCase();
            // Verificar si expl√≠citamente es unidad de peso
            if (u.includes('kg') || u.includes('kilo') || u.includes('gr') || u.includes('gramo')) return true;
            
            // Si no dice unidad, miramos si tiene Peso Promedio configurado (mayor a 0 y distinto de 1)
            // .toString().replace() es para manejar "4,5" como 4.5
            const peso = p.Peso_Promedio ? parseFloat(p.Peso_Promedio.toString().replace(',','.')) : 0;
            if (peso > 0 && peso !== 1) return true;
            
            return false;
        }

        function toggleModoVenta(idProducto) {
            state.modoBulto[idProducto] = !state.modoBulto[idProducto];
            renderizarProductos(document.getElementById('searchInput').value);
            actualizarCarritoUI(); // Actualizar totales tambi√©n
        }

        function renderizarProductos(filtro = "") {
            const lista = document.getElementById('productList');
            lista.innerHTML = "";
            
            const filtrados = state.productos.filter(p => {
                const textoProd = `${p.Nombre} ${p.Categoria} ${p.ID_Producto}`;
                return coincidenciaFlexible(textoProd, filtro);
            });

            if (filtrados.length === 0) {
                lista.innerHTML = `<div class="col-span-full text-center py-10 text-[var(--text-sub)]">No se encontraron productos</div>`;
                return;
            }

            filtrados.forEach(p => {
                const qty = state.carrito[p.ID_Producto] || 0;
                const isSelected = qty > 0;
                
                // --- L√ìGICA DE PRECIOS UNIFICADA ---
                const esProductoPesable = esPesable(p);
                const pesoPromedio = p.Peso_Promedio ? parseFloat(p.Peso_Promedio.toString().replace(',','.')) : 1;
                const unidadesPorBulto = p.Unidades_Bulto ? parseInt(p.Unidades_Bulto) : 1;
                const tieneBulto = unidadesPorBulto > 1;
                const enModoBulto = state.modoBulto[p.ID_Producto] || false;

                // Definimos el factor de precio base (Precio de 1 ITEM en el carrito)
                let factorPrecio = 1;

                if (esProductoPesable) {
                    if (tieneBulto && enModoBulto) {
                        // Caso: Bulto Pesable -> PrecioUnitario * UnidadesBulto * PesoPromedio
                        factorPrecio = pesoPromedio * unidadesPorBulto;
                    } else {
                        // Caso: Pieza Pesable (Single) -> PrecioUnitario * PesoPromedio
                        factorPrecio = pesoPromedio;
                    }
                } else {
                    // No Pesable (Unidades normales)
                    factorPrecio = (enModoBulto ? unidadesPorBulto : 1);
                }

                const precioVisual = p.Precio_Unitario * factorPrecio;

                // Etiquetas Visuales
                let etiquetaTipo = "";
                let etiquetaPeso = "";

                if (esProductoPesable) {
                    if (enModoBulto) {
                        etiquetaTipo = "x Bulto";
                        etiquetaPeso = `(~${(pesoPromedio * unidadesPorBulto).toFixed(1)}kg)`;
                    } else {
                        etiquetaTipo = "x Pieza"; // Identificador "1 pieza" solicitado
                        etiquetaPeso = `(~${pesoPromedio}kg)`;
                    }
                } else {
                    if (enModoBulto) {
                        etiquetaTipo = "x Bulto";
                        etiquetaPeso = `(${unidadesPorBulto} u.)`;
                    } else {
                        etiquetaTipo = "Unitario";
                    }
                }
                
                // Stock visual seguro
                const stockDisplay = (p.Stock_Actual !== undefined && p.Stock_Actual !== "") ? `${p.Stock_Actual} ${p.Unidad || ''}` : "";

                const card = document.createElement('div');
                card.className = `md-card p-4 relative flex flex-col justify-between h-full border-2 ${isSelected ? 'border-[var(--primary)] bg-blue-50 dark:bg-blue-900/20' : 'border-transparent'}`;
                
                // Switch HTML (Solo si Unidades_Bulto > 1)
                let switchHtml = '';
                if (tieneBulto) {
                    switchHtml = `
                        <div class="flex items-center gap-2 mb-2 text-xs font-medium text-[var(--text-sub)] bg-gray-100 dark:bg-gray-800 p-1.5 rounded-lg w-fit">
                            <span class="${!enModoBulto ? 'text-[var(--primary)] font-bold' : ''}">${esProductoPesable ? 'Pieza' : 'Unit'}</span>
                            <input type="checkbox" class="toggle-switch" ${enModoBulto ? 'checked' : ''} onchange="toggleModoVenta('${p.ID_Producto}')">
                            <span class="${enModoBulto ? 'text-[var(--primary)] font-bold' : ''}">Bulto</span>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="mb-2">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-bold text-[var(--text-sub)] bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded uppercase tracking-wider mb-1 block w-fit">${p.Categoria}</span>
                            ${esProductoPesable ? `<span class="text-[10px] bg-yellow-100 text-yellow-800 px-1 rounded border border-yellow-200">Pesable</span>` : ''}
                        </div>
                        
                        <h3 class="text-sm font-medium text-[var(--text-main)] mt-1 leading-tight">${p.Nombre}</h3>
                        ${switchHtml}
                        <p class="text-xs text-[var(--text-sub)] mt-0.5">${stockDisplay}</p>
                    </div>
                    
                    <div class="flex items-end justify-between mt-auto pt-2">
                        <div class="flex flex-col">
                            <span class="text-lg font-bold text-[var(--primary)]">$${precioVisual.toLocaleString()}</span>
                            <div class="flex flex-col leading-none">
                                <span class="text-[10px] text-[var(--text-sub)] font-bold">${etiquetaTipo}</span>
                                <span class="text-[9px] text-[var(--text-sub)]">${etiquetaPeso}</span>
                            </div>
                        </div>
                        
                        ${isSelected ? `
                        <div class="flex items-center bg-[var(--primary-container)] rounded-full px-1 py-1 gap-2">
                            <button onclick="cambiarCant('${p.ID_Producto}', -1)" class="w-7 h-7 bg-white dark:bg-black rounded-full flex items-center justify-center text-[var(--primary)] shadow-sm active:scale-90 transition"><i class="ph-bold ph-minus text-xs"></i></button>
                            
                            <span class="text-lg font-bold text-[var(--on-primary-container)] min-w-[1rem] text-center">${qty}</span>
                            
                            <button onclick="cambiarCant('${p.ID_Producto}', 1)" class="w-7 h-7 bg-[var(--primary)] rounded-full flex items-center justify-center text-white shadow-sm active:scale-90 transition"><i class="ph-bold ph-plus text-xs"></i></button>
                        </div>` : 
                        `<button onclick="cambiarCant('${p.ID_Producto}', 1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-[var(--primary)] flex items-center justify-center hover:bg-[var(--primary-container)] transition"><i class="ph-bold ph-plus"></i></button>`}
                    </div>
                `;
                lista.appendChild(card);
            });
        }

        // --- 3. L√ìGICA DEL CARRITO ---
        function cambiarCant(id, delta) {
            if (!state.carrito[id]) state.carrito[id] = 0;
            state.carrito[id] += delta;
            
            // Ahora qty es SIEMPRE entero (representa unidades de venta seleccionadas)
            state.carrito[id] = Math.round(state.carrito[id]); 

            if (state.carrito[id] <= 0) delete state.carrito[id];

            const busqueda = document.getElementById('searchInput').value;
            renderizarProductos(busqueda);
            actualizarCarritoUI();
        }

        // Funci√≥n auxiliar para calcular totales basada en la l√≥gica unificada
        function calcularTotalItem(p, qty) {
            const esProductoPesable = esPesable(p);
            const pesoPromedio = p.Peso_Promedio ? parseFloat(p.Peso_Promedio.toString().replace(',','.')) : 1;
            const unidadesPorBulto = p.Unidades_Bulto ? parseInt(p.Unidades_Bulto) : 1;
            const tieneBulto = unidadesPorBulto > 1;
            const enModoBulto = state.modoBulto[p.ID_Producto] || false;

            let factorPrecio = 1;
            // L√≥gica de c√°lculo estricta solicitada
            if (esProductoPesable) {
                if (tieneBulto && enModoBulto) {
                     // Bulk pesable: Precio * Peso * CantidadBulto
                     factorPrecio = pesoPromedio * unidadesPorBulto;
                } else {
                     // Pieza pesable (Single): Precio * Peso
                     factorPrecio = pesoPromedio;
                }
            } else {
                factorPrecio = (enModoBulto ? unidadesPorBulto : 1);
            }
            
            const total = p.Precio_Unitario * factorPrecio * qty;
            
            let desc = "";
            if (enModoBulto) {
                desc = `${qty} Bulto${qty > 1 ? 's' : ''}`;
                if (esProductoPesable) desc += ` (~${(pesoPromedio * unidadesPorBulto * qty).toFixed(1)}kg)`;
            } else {
                desc = `${qty} ${esProductoPesable ? 'Pieza' : 'Unidad'}${qty > 1 ? 's' : ''}`;
                if (esProductoPesable) desc += ` (~${(pesoPromedio * qty).toFixed(1)}kg)`;
            }

            return { total, desc };
        }

        function actualizarCarritoUI() {
            const items = Object.entries(state.carrito);
            let totalGeneral = 0;
            let count = 0;

            items.forEach(([id, qty]) => {
                const p = state.productos.find(prod => prod.ID_Producto == id);
                if (p) {
                    const info = calcularTotalItem(p, qty);
                    totalGeneral += info.total;
                    count += 1; 
                }
            });

            document.getElementById('itemCount').textContent = count;
            document.getElementById('totalAmount').textContent = `$${totalGeneral.toLocaleString()}`;
            document.getElementById('modalTotal').textContent = `$${totalGeneral.toLocaleString()}`;

            const footer = document.getElementById('cartFooter');
            if (Object.keys(state.carrito).length > 0) {
                footer.classList.remove('translate-y-full');
            } else {
                footer.classList.add('translate-y-full');
                document.getElementById('cartModal').classList.add('hidden');
            }
            renderizarListaModal();
        }

        function renderizarListaModal() {
            const contenedor = document.getElementById('cartListContainer');
            contenedor.innerHTML = '';

            Object.entries(state.carrito).forEach(([id, qty]) => {
                const p = state.productos.find(prod => prod.ID_Producto == id);
                if (!p) return;

                const info = calcularTotalItem(p, qty);

                const el = document.createElement('div');
                el.className = "flex items-center justify-between p-3 bg-[var(--surface)] rounded-xl border border-gray-100 dark:border-gray-800";
                
                el.innerHTML = `
                    <div class="flex-1 pr-2">
                        <div class="text-sm font-medium text-[var(--text-main)]">${p.Nombre}</div>
                        <div class="text-[var(--primary)] font-bold text-xs">${info.desc}</div>
                        <div class="text-xs text-[var(--text-sub)] mt-1">Total: $${info.total.toLocaleString()}</div>
                    </div>
                    <div class="flex items-center gap-3">
                         <button onclick="cambiarCant('${p.ID_Producto}', -1)" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-red-500"><i class="ph-bold ${qty<=1?'ph-trash':'ph-minus'}"></i></button>
                         <span class="font-bold text-[var(--text-main)] min-w-[1.5rem] text-center">${qty}</span>
                         <button onclick="cambiarCant('${p.ID_Producto}', 1)" class="w-8 h-8 rounded-full bg-[var(--primary)] flex items-center justify-center text-white"><i class="ph-bold ph-plus"></i></button>
                    </div>
                `;
                contenedor.appendChild(el);
            });
        }

        function toggleCartModal() {
            document.getElementById('cartModal').classList.toggle('hidden');
        }

        // --- 4. ENV√çO DE PEDIDOS ---
        async function enviarPedido() {
            const btn = document.getElementById('btn-submit');
            const btnQuick = document.getElementById('btn-quick-submit'); 
            
            const clienteId = document.getElementById('selected-client-id').value;
            const clienteNombre = document.getElementById('selected-client-name').value;
            const clienteTel = document.getElementById('selected-client-phone').value;
            
            if (!clienteId) {
                alert("‚ö†Ô∏è Por favor BUSCA y SELECCIONA un cliente arriba.");
                const modal = document.getElementById('cartModal');
                if(!modal.classList.contains('hidden')) { toggleCartModal(); }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                const input = document.getElementById('client-search-input');
                input.focus();
                input.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => input.classList.remove('ring-2', 'ring-red-500'), 2000);
                return;
            }

            const loadingText = `<i class="ph-duotone ph-spinner animate-spin text-xl"></i> Enviando...`;
            if(btn) { btn.disabled = true; btn.innerHTML = loadingText; }
            if(btnQuick) { btnQuick.disabled = true; btnQuick.innerHTML = loadingText; }

            const itemsArray = [];
            let totalVenta = 0;

            Object.entries(state.carrito).forEach(([id, qty]) => {
                const p = state.productos.find(prod => prod.ID_Producto == id);
                if (p) {
                    const info = calcularTotalItem(p, qty);
                    totalVenta += info.total;

                    itemsArray.push({
                        id: p.ID_Producto,
                        nombre: p.Nombre,
                        cantidad_sistema: qty, // La cantidad de "items" o "bultos" seleccionados
                        detalle: info.desc, // Texto amigable: "2 Bultos (~30kg)"
                        subtotal: info.total
                    });
                }
            });

            // Generar ID √∫nico para historial
            const pedidoIdLocal = Date.now();

            const pedidoFinal = {
                id_interno: pedidoIdLocal, // ID √∫nico local
                cliente: {
                    id: clienteId,
                    nombre: clienteNombre,
                    telefono: clienteTel
                },
                total: totalVenta,
                items: itemsArray,
                fechaLocal: new Date().toLocaleString()
            };

            if (navigator.onLine) {
                try {
                    await fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(pedidoFinal)
                    });
                    
                    // Si se env√≠a bien, guardar en historial como ENVIADO
                    guardarEnHistorial(pedidoFinal, 'Enviado');
                    manejarExito(pedidoFinal, clienteTel);
                    
                } catch (error) {
                    guardarPedidoOffline(pedidoFinal);
                }
            } else {
                guardarPedidoOffline(pedidoFinal);
            }
        }

        function manejarExito(pedido, telefono) {
            alert("‚úÖ Pedido Registrado Exitosamente");

            if(confirm("¬øDeseas enviar el comprobante por WhatsApp?")) {
                abrirWhatsapp(pedido, telefono);
            }
            
            location.reload();
        }

        function abrirWhatsapp(pedido, telefono) {
            // Usamos el campo 'detalle' enriquecido
            const listaItems = pedido.items.map(i => `- ${i.detalle} ${i.nombre}`).join('\n');
            const mensaje = `Hola! Te confirmo pedido:\n${listaItems}\n*Total Estimado: $${pedido.total.toLocaleString()}*`;
            const telLimpio = telefono ? telefono.replace(/[^0-9]/g, '') : "";
            const url = telLimpio ? `https://wa.me/${telLimpio}?text=${encodeURIComponent(mensaje)}` : `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        // --- 5. L√ìGICA DE HISTORIAL Y REPETIR PEDIDO (B√öSQUEDA FLEXIBLE) ---
        function cargarHistorialLocal() {
            const historial = JSON.parse(localStorage.getItem('db_historial') || "[]");
            state.historial = historial;
        }

        function guardarEnHistorial(pedido, estado = 'Enviado') {
            const historial = JSON.parse(localStorage.getItem('db_historial') || "[]");
            pedido.estado = estado;
            historial.unshift(pedido);
            if(historial.length > 50) historial.pop();
            localStorage.setItem('db_historial', JSON.stringify(historial));
            state.historial = historial;
        }

        function toggleHistory() {
            const modal = document.getElementById('historyModal');
            if (modal.classList.contains('hidden')) {
                // Reset filtros al abrir
                document.getElementById('history-search-client').value = '';
                document.getElementById('history-search-date').value = '';
                document.getElementById('clear-history-btn').classList.add('hidden'); // Ocultar X
                renderizarHistorial();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function clearHistorySearch() {
            document.getElementById('history-search-client').value = '';
            document.getElementById('clear-history-btn').classList.add('hidden');
            renderizarHistorial();
            document.getElementById('history-search-client').focus();
        }

        function renderizarHistorial() {
            const container = document.getElementById('historyListContainer');
            container.innerHTML = "";
            
            // --- FILTROS ---
            const filtroTexto = document.getElementById('history-search-client').value;
            const filtroFecha = document.getElementById('history-search-date').value; // YYYY-MM-DD
            
            // Mostrar/Ocultar bot√≥n X del historial
            const clearHistBtn = document.getElementById('clear-history-btn');
            if(filtroTexto && filtroTexto.length > 0) clearHistBtn.classList.remove('hidden');
            else clearHistBtn.classList.add('hidden');

            // Filtrado Flexible
            const historialFiltrado = state.historial.filter(p => {
                // Preparamos "texto completo del pedido" para buscar
                // Incluye: Cliente, ID del pedido, Total, y nombres de TODOS los productos
                const nombresProductos = p.items.map(i => i.nombre).join(" ");
                const textoPedido = `${p.cliente.nombre} ${p.id_interno} ${p.total} ${nombresProductos}`;
                
                const coincideTexto = coincidenciaFlexible(textoPedido, filtroTexto);
                
                let coincideFecha = true;
                if(filtroFecha) {
                    const fechaPedido = new Date(p.id_interno);
                    const partesFecha = filtroFecha.split('-');
                    const anioF = parseInt(partesFecha[0]);
                    const mesF = parseInt(partesFecha[1]) - 1; 
                    const diaF = parseInt(partesFecha[2]);

                    coincideFecha = (
                        fechaPedido.getFullYear() === anioF &&
                        fechaPedido.getMonth() === mesF &&
                        fechaPedido.getDate() === diaF
                    );
                }

                return coincideTexto && coincideFecha;
            });

            if (historialFiltrado.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-[var(--text-sub)] opacity-70">No hay ventas que coincidan.</div>`;
                return;
            }

            historialFiltrado.forEach(p => {
                const el = document.createElement('div');
                el.className = "bg-[var(--surface-container)] border border-gray-100 dark:border-gray-800 rounded-xl p-3 shadow-sm";
                
                const esPendiente = p.estado === 'Pendiente';
                const statusColor = esPendiente 
                    ? 'text-yellow-700 bg-yellow-100 border border-yellow-200' 
                    : 'text-green-700 bg-green-100 border border-green-200';
                
                const iconoEstado = esPendiente ? '<i class="ph-bold ph-clock"></i>' : '<i class="ph-bold ph-check-circle"></i>';

                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-[var(--text-main)] text-sm">${p.cliente.nombre}</div>
                            <div class="text-xs text-[var(--text-sub)]">${p.fechaLocal}</div>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded-md flex items-center gap-1 ${statusColor}">
                            ${iconoEstado} ${p.estado}
                        </span>
                    </div>
                    <div class="flex justify-between items-end border-t border-gray-100 dark:border-gray-700 pt-2 mt-2">
                        <div class="text-xs text-[var(--text-sub)]">${p.items.length} productos</div>
                        <div class="font-bold text-[var(--primary)]">$${p.total.toLocaleString()}</div>
                    </div>
                    <div class="mt-2 pt-2 flex gap-2">
                         <button onclick='repetirPedido(${p.id_interno})' class="flex-1 bg-[var(--primary)] text-white text-xs py-2 rounded-lg font-medium flex items-center justify-center gap-1 hover:opacity-90 transition">
                            <i class="ph-bold ph-arrows-clockwise"></i> Repetir
                        </button>
                        <button onclick='abrirWhatsappHistorial(${p.id_interno})' class="flex-1 bg-green-500 text-white text-xs py-2 rounded-lg font-medium flex items-center justify-center gap-1 hover:bg-green-600 transition">
                            <i class="ph-bold ph-whatsapp-logo"></i> Reenviar
                        </button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function repetirPedido(idInterno) {
            const pedido = state.historial.find(p => p.id_interno === idInterno);
            if (!pedido) return;

            if(!confirm(`¬øCargar los ${pedido.items.length} productos de este pedido al carrito actual?`)) return;

            let agregados = 0;
            let noEncontrados = 0;

            pedido.items.forEach(itemPast => {
                const prodActual = state.productos.find(p => p.ID_Producto === itemPast.id);
                
                if (prodActual) {
                    // Usamos la cantidad del sistema guardada (piezas/bultos)
                    const cantRecuperar = itemPast.cantidad_sistema || itemPast.cantidad; // Fallback para pedidos viejos

                    if (!state.carrito[prodActual.ID_Producto]) state.carrito[prodActual.ID_Producto] = 0;
                    state.carrito[prodActual.ID_Producto] += cantRecuperar;
                    agregados++;
                    
                    // Detectar si era bulto para activar el switch (b√°sico, si la descripcion dice bulto)
                    if(itemPast.detalle && itemPast.detalle.toLowerCase().includes('bulto')) {
                         state.modoBulto[prodActual.ID_Producto] = true;
                    }

                } else {
                    noEncontrados++;
                }
            });
            
            const clienteIdActual = document.getElementById('selected-client-id').value;
            if(!clienteIdActual) {
                 const clienteEnDB = state.clientes.find(c => c.ID_Cliente == pedido.cliente.id);
                 if(clienteEnDB) {
                     seleccionarCliente(clienteEnDB);
                 }
            }

            actualizarCarritoUI();
            renderizarProductos(document.getElementById('searchInput').value);
            toggleHistory(); 

            if(noEncontrados > 0) {
                alert(`‚úÖ Se agregaron ${agregados} productos.\n‚ö†Ô∏è ${noEncontrados} productos ya no existen en el cat√°logo.`);
            } else {
                alert(`‚úÖ ¬°Listo! Productos cargados.`);
            }
            
            toggleCartModal();
        }

        function abrirWhatsappHistorial(idInterno) {
            const pedido = state.historial.find(p => p.id_interno === idInterno);
            if(pedido) {
                abrirWhatsapp(pedido, pedido.cliente.telefono);
            }
        }

        // --- 6. OFFLINE & SYNC ---
        function actualizarEstadoConexion() {
            const offlineBanner = document.getElementById('offline-status');
            if (!navigator.onLine) {
                offlineBanner.classList.remove('hidden');
            } else {
                offlineBanner.classList.add('hidden');
                verificarPendientes();
            }
        }

        function guardarPedidoOffline(pedido) {
            const pendientes = JSON.parse(localStorage.getItem('cola_pedidos') || "[]");
            pendientes.push(pedido);
            localStorage.setItem('cola_pedidos', JSON.stringify(pendientes));
            
            guardarEnHistorial(pedido, 'Pendiente');

            alert("üì∂ SIN CONEXI√ìN: Pedido guardado en el celular.\nSe enviar√° cuando recuperes se√±al.");
            location.reload();
        }

        function verificarPendientes() {
            const pendientes = JSON.parse(localStorage.getItem('cola_pedidos') || "[]");
            const banner = document.getElementById('sync-banner');
            if (pendientes.length > 0) {
                banner.classList.remove('hidden');
                document.getElementById('sync-count').textContent = pendientes.length;
            } else {
                banner.classList.add('hidden');
            }
        }

        async function sincronizarPendientes() {
            const pendientes = JSON.parse(localStorage.getItem('cola_pedidos') || "[]");
            if (pendientes.length === 0 || !navigator.onLine) return;

            if(!confirm(`¬øEnviar los ${pendientes.length} pedidos pendientes ahora?`)) return;

            const banner = document.getElementById('sync-banner');
            banner.textContent = "üì° Enviando... espera...";

            let enviados = 0;
            const errores = [];

            let historial = JSON.parse(localStorage.getItem('db_historial') || "[]");

            for (const pedido of pendientes) {
                try {
                    await fetch(API_URL, { method: "POST", body: JSON.stringify(pedido) });
                    enviados++;
                    
                    const idx = historial.findIndex(h => h.id_interno === pedido.id_interno);
                    if(idx !== -1) {
                        historial[idx].estado = 'Enviado';
                    } else {
                        pedido.estado = 'Enviado';
                        historial.unshift(pedido);
                    }

                } catch (e) {
                    errores.push(pedido);
                }
            }
            
            localStorage.setItem('db_historial', JSON.stringify(historial));
            state.historial = historial;

            localStorage.setItem('cola_pedidos', JSON.stringify(errores));
            alert(`Sincronizaci√≥n: ${enviados} enviados, ${errores.length} fallidos.`);
            location.reload();
        }

        // --- 7. UTILS & UI CONFIG ---
        function clearInput() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.add('hidden');
            renderizarProductos();
        }

        function toggleConfig() {
            document.getElementById('configModal').classList.toggle('hidden');
        }

        function toggleDarkMode(isDark) {
            state.config.darkMode = isDark;
            localStorage.setItem('app_config', JSON.stringify(state.config));
            if(isDark) document.body.classList.add('dark-mode');
            else document.body.classList.remove('dark-mode');
        }

        function cargarConfigLocal() {
            const cfg = JSON.parse(localStorage.getItem('app_config') || '{}');
            state.config = { ...state.config, ...cfg };
            if (state.config.darkMode) {
                document.getElementById('darkModeToggle').checked = true;
                document.body.classList.add('dark-mode');
            }
        }
        
        function recargarDatos() {
            localStorage.removeItem('db_productos');
            localStorage.removeItem('db_clientes');
            location.reload();
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('btn-install').classList.remove('hidden');
        });
        document.getElementById('btn-install').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                document.getElementById('btn-install').classList.add('hidden');
            }
        });
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

    </script>
</body>
</html>
