<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Distribuidora L√°cteos</title>
    
    <!-- --- CONEXI√ìN PWA (Estructura Plana) --- -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0066cc">
    <!-- Icono para iPhone (busca en ra√≠z) -->
    <link rel="apple-touch-icon" href="./icon-192.png">

    <style>
        /* ESTILOS VISUALES */
        :root {
            --primary: #0066cc;
            --success: #28a745;
            --bg: #f4f4f9;
            --card-bg: #ffffff;
            --text: #333333;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); 
            margin: 0; 
            padding-bottom: 100px;
            color: var(--text);
        }

        header { 
            background-color: var(--primary); 
            color: white; 
            padding: 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Contenedor del t√≠tulo y bot√≥n instalar */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 { margin: 0; font-size: 1.1rem; font-weight: normal; }

        /* Estilo del bot√≥n de instalaci√≥n manual */
        #btn-install {
            background-color: white;
            color: var(--primary);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none; /* Oculto por defecto */
        }

        .client-selector { 
            width: 100%; 
            padding: 10px; 
            border-radius: 6px; 
            border: none; 
            font-size: 1rem;
            background: white;
        }

        #app-container { 
            padding: 15px; 
            max-width: 600px; 
            margin: 0 auto; 
        }

        .product-card {
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 12px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .product-card.selected {
            border: 2px solid var(--primary);
            background-color: #f0f7ff;
        }

        .info { flex: 1; }
        .info h3 { margin: 0 0 5px 0; font-size: 1rem; }
        .info p { margin: 0; color: #666; font-size: 0.85rem; }
        .price { font-weight: bold; color: var(--primary); font-size: 1.1rem; }

        .controls { display: flex; align-items: center; gap: 10px; }
        
        .btn-qty {
            width: 32px; height: 32px; 
            border-radius: 50%; border: none;
            font-size: 1.2rem; font-weight: bold; color: white; 
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-minus { background-color: #e0e0e0; color: #555; }
        .btn-plus { background-color: var(--primary); }
        .selected .btn-minus { background-color: #ff4d4d; color: white; }

        .qty-display { font-weight: bold; font-size: 1.1rem; min-width: 25px; text-align: center; }

        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; 
            padding: 15px 20px; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 200;
        }
        
        .total-display { font-size: 1.2rem; font-weight: bold; }
        
        .btn-send {
            background-color: var(--success); 
            color: white; border: none;
            padding: 12px 25px; 
            border-radius: 30px; 
            font-weight: bold; font-size: 1rem;
        }
        .btn-send:disabled { background-color: #cccccc; opacity: 0.7; }

        .loading, .error { text-align: center; padding: 20px; color: #666; margin-top: 20px; }
        .error { color: #dc3545; }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <h1>Distribuidora L√°cteos</h1>
            <!-- Bot√≥n de instalaci√≥n manual (se muestra con JS) -->
            <button id="btn-install">üì≤ Instalar</button>
        </div>
        <select id="client-select" class="client-selector">
            <option value="">Cargando clientes...</option>
        </select>
    </header>

    <div id="app-container">
        <div class="loading">Conectando con la base de datos...</div>
    </div>

    <div class="bottom-bar">
        <div class="total-display">Total: $<span id="total-amount">0</span></div>
        <button id="btn-submit" class="btn-send" onclick="enviarPedido()" disabled>Confirmar</button>
    </div>

    <script>
        // --- ‚ö†Ô∏è PEGA TU URL DE APPS SCRIPT AQU√ç ---
        const API_URL = "https://script.google.com/macros/s/TU_URL_AQUI/exec"; 

        let productos = [];
        let carrito = {}; 

        const container = document.getElementById('app-container');
        const clientSelect = document.getElementById('client-select');
        const totalSpan = document.getElementById('total-amount');
        const btnSubmit = document.getElementById('btn-submit');

        async function iniciarApp() {
            try {
                const [resProd, resCli] = await Promise.all([
                    fetch(API_URL + "?action=getProductos"),
                    fetch(API_URL + "?action=getClientes")
                ]);

                productos = await resProd.json();
                const clientes = await resCli.json();

                renderizarClientes(clientes);
                renderizarProductos(productos);
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="error"><p>‚ö†Ô∏è Error de conexi√≥n.</p></div>`;
            }
        }

        function renderizarClientes(lista) {
            clientSelect.innerHTML = '<option value="">-- Selecciona un Cliente --</option>';
            lista.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.ID_Cliente; 
                opt.textContent = `${c.Nombre_Negocio} (${c.Due√±o})`;
                clientSelect.appendChild(opt);
            });
        }

        function renderizarProductos(lista) {
            container.innerHTML = "";
            lista.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.id = `card-${p.ID_Producto}`;
                card.innerHTML = `
                    <div class="info">
                        <h3>${p.Nombre}</h3>
                        <p>${p.Categoria} | Stock: ${p.Stock_Actual} ${p.Unidad}</p>
                        <div class="price">$${p.Precio_Unitario}</div>
                    </div>
                    <div class="controls">
                        <button class="btn-qty btn-minus" onclick="cambiarCant('${p.ID_Producto}', -1)">-</button>
                        <span class="qty-display" id="qty-${p.ID_Producto}">0</span>
                        <button class="btn-qty btn-plus" onclick="cambiarCant('${p.ID_Producto}', 1)">+</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function cambiarCant(id, delta) {
            if (!carrito[id]) carrito[id] = 0;
            carrito[id] += delta;
            if (carrito[id] < 0) carrito[id] = 0;

            document.getElementById(`qty-${id}`).textContent = carrito[id];
            const card = document.getElementById(`card-${id}`);
            if (carrito[id] > 0) card.classList.add('selected');
            else card.classList.remove('selected');

            calcularTotal();
        }

        function calcularTotal() {
            let total = 0;
            let itemsCount = 0;
            productos.forEach(p => {
                const cant = carrito[p.ID_Producto] || 0;
                if (cant > 0) {
                    total += cant * p.Precio_Unitario;
                    itemsCount++;
                }
            });
            totalSpan.textContent = total.toLocaleString();
            
            const clienteSeleccionado = clientSelect.value;
            if (itemsCount > 0 && clienteSeleccionado !== "") {
                btnSubmit.disabled = false;
                btnSubmit.textContent = `Confirmar ($${totalSpan.textContent})`;
            } else {
                btnSubmit.disabled = true;
                btnSubmit.textContent = "Confirmar";
            }
        }

        clientSelect.addEventListener('change', () => calcularTotal());

        async function enviarPedido() {
            btnSubmit.disabled = true;
            btnSubmit.textContent = "Enviando...";

            const itemsArray = [];
            let totalVenta = 0;

            productos.forEach(p => {
                const cant = carrito[p.ID_Producto] || 0;
                if (cant > 0) {
                    const subtotal = cant * p.Precio_Unitario;
                    totalVenta += subtotal;
                    itemsArray.push({
                        id: p.ID_Producto,
                        nombre: p.Nombre,
                        cantidad: cant,
                        subtotal: subtotal
                    });
                }
            });

            const pedidoFinal = {
                cliente: {
                    id: clientSelect.value,
                    nombre: clientSelect.options[clientSelect.selectedIndex].text
                },
                total: totalVenta,
                items: itemsArray
            };

            try {
                await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(pedidoFinal)
                });
                alert("‚úÖ Pedido guardado correctamente");
                location.reload(); 
            } catch (error) {
                alert("‚ùå Error de conexi√≥n.");
                btnSubmit.disabled = false;
                btnSubmit.textContent = "Reintentar";
            }
        }

        iniciarApp();
    </script>

    <!-- --- LOGICA DE INSTALACI√ìN PWA Y DEPURACI√ìN --- -->
    <script>
        // 1. Registro del Service Worker con LOGS
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('‚úÖ [PWA] Service Worker registrado. Scope:', reg.scope))
                    .catch(err => console.error('‚ùå [PWA] Fall√≥ el SW:', err));
            });
        }

        // 2. L√≥gica del Bot√≥n de Instalaci√≥n
        let deferredPrompt;
        const installBtn = document.getElementById('btn-install');

        // Escuchamos el evento m√°gico del navegador
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéâ [PWA] ¬°El navegador dice que la App es instalable!');
            // Prevenimos que el navegador muestre su barra autom√°tica (opcional)
            e.preventDefault();
            // Guardamos el evento para lanzarlo cuando queramos
            deferredPrompt = e;
            // Mostramos nuestro bot√≥n
            installBtn.style.display = 'block';
        });

        // Al hacer clic en el bot√≥n
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Lanzamos la pregunta nativa
                deferredPrompt.prompt();
                // Esperamos la respuesta del usuario
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`[PWA] El usuario decidi√≥: ${outcome}`);
                // Limpiamos
                deferredPrompt = null;
                // Ocultamos bot√≥n
                installBtn.style.display = 'none';
            }
        });

        // Evento cuando ya se instal√≥
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ [PWA] ¬°La App fue instalada exitosamente!');
        });
    </script>

</body>
</html>
