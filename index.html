<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Distribuidora Lácteos</title>

    <!-- --- CONEXIÓN PWA (Para instalar en el celular) --- -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0066cc">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <style>
        /* --- ESTILOS VISUALES (CSS) --- */
        :root {
            --primary: #0066cc;
            /* Azul Institucional */
            --success: #28a745;
            /* Verde Confirmar */
            --bg: #f4f4f9;
            /* Fondo Gris Claro */
            --card-bg: #ffffff;
            /* Fondo Tarjetas */
            --text: #333333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding-bottom: 100px;
            /* Espacio para barra inferior */
            color: var(--text);
        }

        /* Cabecera Fija */
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            font-weight: normal;
        }

        .client-selector {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-size: 1rem;
            background: white;
        }

        /* Contenedor Principal */
        #app-container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Tarjeta de Producto */
        .product-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        .product-card.selected {
            border: 2px solid var(--primary);
            background-color: #f0f7ff;
        }

        .info {
            flex: 1;
        }

        .info h3 {
            margin: 0 0 5px 0;
            font-size: 1rem;
        }

        .info p {
            margin: 0;
            color: #666;
            font-size: 0.85rem;
        }

        .price {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* Botones de Cantidad */
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-qty {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        .btn-minus {
            background-color: #e0e0e0;
            color: #555;
        }

        .btn-plus {
            background-color: var(--primary);
        }

        /* Cuando está seleccionado, el menos se pone rojo para borrar */
        .selected .btn-minus {
            background-color: #ff4d4d;
            color: white;
        }

        .qty-display {
            font-weight: bold;
            font-size: 1.1rem;
            min-width: 25px;
            text-align: center;
        }

        /* Barra Inferior (Total) */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 200;
        }

        .total-display {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .btn-send {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            transition: opacity 0.3s;
        }

        .btn-send:disabled {
            background-color: #cccccc;
            opacity: 0.7;
        }

        /* Mensajes de Estado */
        .loading,
        .error {
            text-align: center;
            padding: 20px;
            color: #666;
            margin-top: 20px;
        }

        .error {
            color: #dc3545;
        }
    </style>
</head>

<body>

    <header>
        <h1>Distribuidora Lácteos</h1>
        <!-- Selector de Clientes -->
        <select id="client-select" class="client-selector">
            <option value="">Cargando clientes...</option>
        </select>
    </header>

    <div id="app-container">
        <div class="loading">Conectando con la base de datos...</div>
    </div>

    <!-- Barra Inferior Flotante -->
    <div class="bottom-bar">
        <div class="total-display">Total: $<span id="total-amount">0</span></div>
        <button id="btn-submit" class="btn-send" onclick="enviarPedido()" disabled>Confirmar</button>
    </div>

    <script>
        // --- 1. CONFIGURACIÓN DEL SISTEMA ---

        // ⚠️ PEGA AQUÍ TU URL DE GOOGLE APPS SCRIPT (La que termina en /exec)
        const API_URL = "https://script.google.com/macros/s/AKfycbyD1aKqu_YRB7E3T5nxXiLnd0zx7lQ9lV0AUbpbjWmWgLMdVqiDwz4HXPYi-o9Lci0QSg/exec";

        // --- 2. LÓGICA DE LA APP ---

        let productos = [];
        let carrito = {}; // { ID_Producto: Cantidad }

        // Elementos visuales
        const container = document.getElementById('app-container');
        const clientSelect = document.getElementById('client-select');
        const totalSpan = document.getElementById('total-amount');
        const btnSubmit = document.getElementById('btn-submit');

        // Función Inicial: Carga datos al abrir
        async function iniciarApp() {
            try {
                // Pedimos Productos y Clientes al mismo tiempo (Paralelo)
                const [resProd, resCli] = await Promise.all([
                    fetch(API_URL + "?action=getProductos"),
                    fetch(API_URL + "?action=getClientes")
                ]);

                productos = await resProd.json();
                const clientes = await resCli.json();

                renderizarClientes(clientes);
                renderizarProductos(productos);

            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="error">
                    <p>⚠️ No se pudo conectar.</p>
                    <p>Verifica tu internet o la URL del script.</p>
                </div>`;
            }
        }

        // Rellenar el selector de clientes
        function renderizarClientes(lista) {
            clientSelect.innerHTML = '<option value="">-- Selecciona un Cliente --</option>';
            lista.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.ID_Cliente;
                opt.textContent = `${c.Nombre_Negocio} (${c.Dueño})`;
                clientSelect.appendChild(opt);
            });
        }

        // Dibujar la lista de productos
        function renderizarProductos(lista) {
            container.innerHTML = "";
            lista.forEach(p => {
                // Crear tarjeta
                const card = document.createElement('div');
                card.className = 'product-card';
                card.id = `card-${p.ID_Producto}`;

                card.innerHTML = `
                    <div class="info">
                        <h3>${p.Nombre}</h3>
                        <p>${p.Categoria} | Stock: ${p.Stock_Actual} ${p.Unidad}</p>
                        <div class="price">$${p.Precio_Unitario}</div>
                    </div>
                    <div class="controls">
                        <button class="btn-qty btn-minus" onclick="cambiarCant('${p.ID_Producto}', -1)">-</button>
                        <span class="qty-display" id="qty-${p.ID_Producto}">0</span>
                        <button class="btn-qty btn-plus" onclick="cambiarCant('${p.ID_Producto}', 1)">+</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Lógica de sumar/restar
        function cambiarCant(id, delta) {
            if (!carrito[id]) carrito[id] = 0;
            carrito[id] += delta;

            if (carrito[id] < 0) carrito[id] = 0; // Evitar negativos

            // Actualizar número visual
            document.getElementById(`qty-${id}`).textContent = carrito[id];

            // Resaltar tarjeta si tiene items
            const card = document.getElementById(`card-${id}`);
            if (carrito[id] > 0) card.classList.add('selected');
            else card.classList.remove('selected');

            calcularTotal();
        }

        // Calcular total $$$
        function calcularTotal() {
            let total = 0;
            let itemsCount = 0;

            productos.forEach(p => {
                const cant = carrito[p.ID_Producto] || 0;
                if (cant > 0) {
                    total += cant * p.Precio_Unitario;
                    itemsCount++;
                }
            });

            totalSpan.textContent = total.toLocaleString(); // Formato moneda (1.500)

            // Habilitar botón solo si hay cliente y productos
            verificarBoton(itemsCount);
        }

        // Escuchar cambios en el selector de cliente
        clientSelect.addEventListener('change', () => calcularTotal());

        function verificarBoton(itemsCount) {
            const clienteSeleccionado = clientSelect.value;
            if (itemsCount > 0 && clienteSeleccionado !== "") {
                btnSubmit.disabled = false;
                btnSubmit.textContent = `Confirmar ($${totalSpan.textContent})`;
            } else {
                btnSubmit.disabled = true;
                btnSubmit.textContent = "Confirmar";
            }
        }

        // Enviar pedido a Google Sheet
        async function enviarPedido() {
            btnSubmit.disabled = true;
            btnSubmit.textContent = "Enviando...";

            const clienteNombre = clientSelect.options[clientSelect.selectedIndex].text;

            // Preparar items
            const itemsArray = [];
            let totalVenta = 0;

            productos.forEach(p => {
                const cant = carrito[p.ID_Producto] || 0;
                if (cant > 0) {
                    const subtotal = cant * p.Precio_Unitario;
                    totalVenta += subtotal;
                    itemsArray.push({
                        id: p.ID_Producto,
                        nombre: p.Nombre,
                        cantidad: cant,
                        subtotal: subtotal
                    });
                }
            });

            const pedidoFinal = {
                cliente: {
                    id: clientSelect.value,
                    nombre: clienteNombre
                },
                total: totalVenta,
                items: itemsArray
            };

            // Enviar
            try {
                // Usamos fetch normal (POST)
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(pedidoFinal)
                });

                // Si llegamos aquí, ¡éxito!
                alert("✅ Pedido guardado correctamente");
                location.reload(); // Recargar para limpiar

            } catch (error) {
                console.error(error);
                alert("❌ Error de conexión. Inténtalo de nuevo.");
                btnSubmit.disabled = false;
                btnSubmit.textContent = "Reintentar";
            }
        }

        // Arrancar la app
        iniciarApp();

    </script>

    <!-- --- 3. REGISTRO DEL SERVICE WORKER (Para instalar PWA) --- -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('✅ Service Worker registrado', reg))
                    .catch(err => console.log('❌ Error al registrar SW', err));
            });
        }
    </script>

</body>

</html>
